---
story_id: 005
title: 配置管理与差异检测
status: completed
depends_on: [004]
---

# Story 005: 配置管理与差异检测

## 上下文

### 需求来源
> 来源：P1-需求文档.md#三、功能需求

- F002 ideal config：查看/修改项目配置
- F003 ideal update：更新时检测用户修改，冲突时提示选择

### 技术方案
> 来源：P3-技术方案.md#三、功能模块设计

**配置存储位置**：`.claude/project-config.md` 的 YAML frontmatter

**元数据存储**：`.claude/.metadata.json`
```json
{
  "version": "1.0.0",
  "initializedAt": "2026-02-23T10:00:00Z",
  "templateVersion": "1.2.0",
  "files": {
    ".claude/agents/pm.md": {
      "originalHash": "abc123",
      "remoteVersion": "1.2.0"
    }
  }
}
```

### 相关代码

已完成的模块（Story 004）：
- `src/utils/file-system.ts` - 文件操作
- `src/types/config.ts` - 配置类型

## 任务清单

- [x] M018-1: 实现 ConfigManager 类
  - [x] 创建 src/services/config-manager.ts
  - [x] 实现 ConfigManager 类
- [x] M018-2: 实现 read 方法
  - [x] 读取 project-config.md
  - [x] 解析 YAML frontmatter
  - [x] 返回 ProjectConfig 对象
- [x] M018-3: 实现 write 方法
  - [x] 写入配置文件
  - [x] 生成 YAML frontmatter
  - [x] 保留文件正文内容
- [x] M018-4: 实现 validate 方法
  - [x] 校验必填字段
  - [x] 返回校验结果
- [x] M019-1: 实现 DiffManager 类
  - [x] 创建 src/services/diff-manager.ts
  - [x] 实现 DiffManager 类
- [x] M019-2: 实现 compare 方法
  - [x] 对比本地和远程文件哈希
  - [x] 返回 DiffResult
- [x] M019-3: 实现冲突检测
  - [x] 实现 isUserModified(path) 方法
  - [x] 读取元数据对比原始哈希
- [x] M019-4: 实现元数据管理
  - [x] 实现 readMetadata() 方法
  - [x] 实现 writeMetadata() 方法
  - [x] 元数据文件路径：.claude/.metadata.json

## 验收标准

### 功能验收
- [x] ConfigManager.read 正确解析 YAML frontmatter
- [x] ConfigManager.write 正确生成配置文件
- [x] DiffManager.compare 正确检测文件差异
- [x] isUserModified 正确判断用户修改

### 代码质量
- [x] YAML 解析使用 gray-matter 库
- [x] 错误处理完善
- [x] 类型定义完整

## 实现笔记

**完成时间**: 2026-02-23

**已创建文件**:
- `src/services/config-manager.ts` - 配置管理器（22 个测试）
  - read, write, validate, createDefaultConfig
  - updateWorkflow, configExists
- `src/services/diff-manager.ts` - 差异检测器（30 个测试）
  - compare, isUserModified, readMetadata, writeMetadata
  - createInitialMetadata, updateFileMetadata
  - getUserModifiedFiles, scanLocalFiles, syncMetadata
- `src/types/metadata.ts` - 元数据类型定义
  - ProjectMetadata, FileMetadata
  - FileDiff, FileDiffStatus, DiffResult
- `tests/config-manager.test.ts` - 配置管理器测试
- `tests/diff-manager.test.ts` - 差异检测器测试

**验证结果**:
- TypeScript 类型检查: ✅ 通过
- 构建: ✅ 成功
- 测试: ✅ 216 个测试通过
