---
story_id: 003
title: 文件系统与网络工具
status: completed
depends_on: [002]
---

# Story 003: 文件系统与网络工具

## 上下文

### 需求来源
> 来源：P1-需求文档.md#三、功能需求

- 创建目录结构：`.claude/agents/`、`.claude/skills/`、`docs/迭代/`、`docs/Wiki/`
- 从 GitHub 仓库拉取最新模板
- 离线环境时报错退出

### 技术方案
> 来源：P3-技术方案.md#二、系统架构

- 文件操作：fs-extra（Promise API）
- 网络请求：axios
- 支持代理：HTTP_PROXY 环境变量

### 相关代码

已完成的模块（Story 002）：
- `src/utils/logger.ts` - 日志工具
- `src/constants/defaults.ts` - 默认值常量

## 任务清单

- [x] M014-1: 实现目录操作
  - [x] 创建 src/utils/file-system.ts
  - [x] 实现 ensureDir(path) - 确保目录存在
  - [x] 实现 isEmpty(path) - 检查目录是否为空
  - [x] 实现 copyDir(src, dest) - 复制目录
- [x] M014-2: 实现文件读写
  - [x] 实现 readFile(path) - 读取文件
  - [x] 实现 writeFile(path, content) - 写入文件
  - [x] 实现 fileExists(path) - 检查文件是否存在
  - [x] 实现模板变量替换（Mustache）
- [x] M014-3: 实现哈希计算
  - [x] 实现 calculateHash(content) - MD5 哈希
- [x] M014-4: 实现路径处理
  - [x] 实现跨平台路径处理（使用 path 模块）
  - [x] 实现 getProjectRoot() - 获取项目根目录
- [x] M015-1: 实现 HTTP 客户端
  - [x] 创建 src/utils/http.ts
  - [x] 配置 axios 实例
  - [x] 实现请求/响应拦截器
- [x] M015-2: 实现错误处理
  - [x] 实现网络错误统一处理
  - [x] 实现超时处理（30秒）
  - [x] 抛出清晰的错误消息
- [x] M015-3: 实现代理支持
  - [x] 读取 HTTP_PROXY/HTTPS_PROXY 环境变量
  - [x] 配置 axios 代理

## 验收标准

### 功能验收
- [x] ensureDir 创建多级目录成功
- [x] copyDir 递归复制目录成功
- [x] calculateHash 返回正确的 MD5 哈希
- [x] HTTP 请求成功（mock 测试）
- [x] 网络错误正确捕获和处理
- [x] 代理配置正确应用

### 代码质量
- [x] 所有方法返回 Promise
- [x] 错误消息清晰易懂
- [x] 跨平台兼容（macOS/Linux/Windows）

## 实现笔记

**完成时间**: 2026-02-23

**已创建文件**:
- `src/utils/file-system.ts` - 文件系统工具（34 个测试）
  - 目录操作：ensureDir, isEmpty, copyDir, walkDir
  - 文件读写：readFile, writeFile, fileExists, pathExists
  - 模板渲染：renderTemplate, renderTemplateFile
  - 哈希计算：calculateHash, calculateFileHash
  - 路径处理：getProjectRoot, normalizePath, joinPaths 等
- `src/utils/http.ts` - HTTP 客户端（20 个测试）
  - axios 实例配置
  - 请求/响应拦截器
  - 错误处理（NetworkError 类）
  - 代理支持（HTTP_PROXY/HTTPS_PROXY）
  - 重试机制（withRetry）
- `tests/file-system.test.ts` - 文件系统测试
- `tests/http.test.ts` - HTTP 测试

**验证结果**:
- TypeScript 类型检查: ✅ 通过
- 构建: ✅ 成功
- 测试: ✅ 63 个测试通过
