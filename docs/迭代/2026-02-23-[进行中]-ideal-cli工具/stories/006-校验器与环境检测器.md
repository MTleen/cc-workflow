---
story_id: 006
title: 校验器与环境检测器
status: completed
depends_on: [003]
---

# Story 006: 校验器与环境检测器

## 上下文

### 需求来源
> 来源：P1-需求文档.md#三、功能需求

F004 ideal doctor：检查工作流配置完整性和有效性

### 技术方案
> 来源：P3-技术方案.md#三、功能模块设计

**检查项清单**：

| 检查项 | 检查内容 | 级别 |
|--------|----------|------|
| directory-structure | 必需目录是否存在 | error |
| config-format | CLAUDE.md 格式是否正确 | error |
| project-config | project-config.md 是否存在 | warning |
| node-version | Node.js 版本 >= 18 | warning |
| python-version | Python 版本 >= 3.10 | info |
| version-compat | 模板版本与 CLI 兼容性 | warning |

**输出格式**：
```
✓ directory-structure: 目录结构完整
✓ config-format: 配置文件格式正确
⚠ python-version: Python 版本过低 (3.8 < 3.10)
✓ version-compat: 版本兼容

诊断结果: 3 项通过, 1 项警告
```

### 相关代码

已完成的模块（Story 003）：
- `src/utils/file-system.ts` - 文件操作
- `src/types/doctor.ts` - 诊断类型

## 任务清单

- [x] M020-1: 实现 Validator 类
  - [x] 创建 src/services/validator.ts
  - [x] 实现 Validator 类
- [x] M020-2: 实现配置校验
  - [x] 实现 validateConfig(config) 方法
  - [x] 校验必填字段
  - [x] 返回 ValidationResult
- [x] M020-3: 实现路径校验
  - [x] 实现 validatePath(path) 方法
  - [x] 检查路径安全性
- [x] M021-1: 实现 Detector 类
  - [x] 创建 src/utils/detector.ts
  - [x] 实现 Detector 类
- [x] M021-2: 实现版本检测
  - [x] 实现 checkNodeVersion() 方法
  - [x] 实现 checkPythonVersion() 方法
  - [x] 返回版本信息
- [x] M021-3: 实现目录结构检测
  - [x] 实现 checkDirectoryStructure() 方法
  - [x] 检查 .claude/ 目录
  - [x] 检查 docs/ 目录
- [x] M021-4: 实现完整诊断
  - [x] 实现 runAllChecks() 方法
  - [x] 返回 DoctorResult

## 验收标准

### 功能验收
- [x] checkNodeVersion 正确检测 Node.js 版本
- [x] checkPythonVersion 正确检测 Python 版本
- [x] checkDirectoryStructure 正确检测目录结构
- [x] runAllChecks 返回完整的诊断结果
- [x] 结果包含 passed/warnings/errors 统计

### 代码质量
- [x] 版本比较使用 semver 库
- [x] 检查项可配置
- [x] 类型定义完整

## 实现笔记

**完成时间**: 2026-02-23

**已创建文件**:
- `src/utils/detector.ts` - 项目检测工具（35 个测试）
  - detectProjectRoot, detectTechStack, detectGitRepo
  - getGitBranch, getGitRemoteUrl, detectPackageManager
  - detectProjectName, detectIdealInitialized, detectProjectInfo
- `src/services/validator.ts` - 项目校验器（28 个测试）
  - checkNodeVersion, checkGitInstalled
  - checkProjectDirectory, checkGitRepository
  - checkIdealInitialized, checkConfigValid
  - checkClaudeMd, checkClaudeDirectory
  - runAllChecks, validateForInit, validateForCommand
- `tests/detector.test.ts` - 检测器测试
- `tests/validator.test.ts` - 校验器测试

**验证结果**:
- TypeScript 类型检查: ✅ 通过
- 构建: ✅ 成功
- 测试: ✅ 164 个测试通过
