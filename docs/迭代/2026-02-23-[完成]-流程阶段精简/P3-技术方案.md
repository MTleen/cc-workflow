---
需求名称: 流程阶段精简——删除上线阶段并新增成果提交阶段
关联需求: P1-需求文档.md
创建时间: 2026-02-23
当前阶段: P3
---

# P3-技术方案：流程阶段精简——删除上线阶段并新增成果提交阶段

## 一、方案概述

### 1.1 设计目标

基于 P1 需求文档，将 CC-Workflow 的 16 阶段流程精简为 15 阶段，删除与 CI/CD 职责重叠的上线阶段，新增成果提交阶段以明确代码合并、worktree 清理和 PR 提交的归属。

### 1.2 核心设计原则

| 原则 | 说明 |
|------|------|
| **职责分离** | 上线部署由 CI/CD 自动化完成，工作流只负责到成果提交 |
| **向后兼容** | 现有流程状态文件提供迁移路径 |
| **最小变更** | 仅修改阶段编号和定义，不改变 Skill 核心逻辑 |
| **全面覆盖** | 所有涉及阶段编号的文件均需同步更新 |

### 1.3 技术栈选型

| 层级 | 技术选型 | 选型理由 |
|------|----------|----------|
| 文档格式 | Markdown | 现有格式，无需变更 |
| 全局搜索 | Grep + Bash | 快速定位所有需要修改的文件 |
| 批量替换 | Edit 工具 | 精确控制每个修改点 |
| 验证方法 | 全局搜索 | 确保无遗漏引用 |

---

## 二、系统架构

### 2.1 整体架构图（重构前后对比）

**重构前（16阶段）：**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            16 阶段流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  【规划阶段】                                                             │
│   P1(需求编写) ──▶ P2(需求评审) ──▶ P3(技术方案) ──▶ P4(方案评审)        │
│                                                                          │
│  【准备阶段】                                                             │
│   P5(计划生成) ──▶ P6(计划评审) ──▶ P7(测试用例) ──▶ P8(用例评审)        │
│                                                                          │
│  【执行阶段】                                                             │
│   P9(开发执行) ──▶ P10(代码评审) ──▶ P11(测试执行) ──▶ P12(测试评审)     │
│                                                                          │
│  【收尾阶段】                                                             │
│   P13(上线评审) ──▶ P14(部署上线) ──▶ P15(维基更新) ──▶ P16(维基评审)    │
│        人工            自动             Claude            人工           │
└─────────────────────────────────────────────────────────────────────────┘
```

**重构后（15阶段）：**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            15 阶段流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  【规划阶段】                                                             │
│   P1(需求编写) ──▶ P2(需求评审) ──▶ P3(技术方案) ──▶ P4(方案评审)        │
│                                                                          │
│  【准备阶段】                                                             │
│   P5(计划生成) ──▶ P6(计划评审) ──▶ P7(测试用例) ──▶ P8(用例评审)        │
│                                                                          │
│  【执行阶段】                                                             │
│   P9(开发执行) ──▶ P10(代码评审) ──▶ P11(测试执行) ──▶ P12(测试评审)     │
│                                                                          │
│  【收尾阶段】                                                             │
│   P13(维基更新) ──▶ P14(维基评审) ──▶ P15(成果提交) ──▶ CI/CD(自动上线)  │
│        Claude            人工             Claude           自动          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 涉及文件目录结构

```
cc-workflow/
│
├── .claude/
│   ├── CLAUDE.md                              # 更新阶段描述
│   ├── project-config.md                      # 更新模块划分描述
│   └── skills/
│       ├── ideal-flow-control/
│       │   ├── SKILL.md                       # 更新阶段范围
│       │   ├── scripts/flow-state.py          # 更新阶段逻辑
│       │   └── references/flow-state-spec.md  # 核心规范（优先更新）
│       ├── ideal-wiki/
│       │   └── SKILL.md                       # P15 → P13
│       ├── ideal-requirement/
│       │   ├── SKILL.md                       # 更新阶段引用
│       │   └── scripts/generate-flow-status.py
│       └── ideal-init/
│           ├── SKILL.md                       # 更新阶段引用
│           └── references/templates/flow-status.md.tmpl
│
├── docs/
│   └── Wiki/
│       ├── 用户指南/
│       │   ├── 流程概述.md                    # 更新阶段描述
│       │   └── ...
│       └── 开发指南/
│           ├── Skills 索引.md                 # 更新阶段引用
│           └── ...
│
├── ideal-best-practice/
│   └── packages/ideal-dev/skills/
│       ├── ideal-flow-control/                # 同步更新
│       ├── ideal-wiki/                        # 同步更新
│       ├── ideal-requirement/                 # 同步更新
│       └── ideal-init/                        # 同步更新
│
└── README.md                                  # 更新阶段流程定义
```

---

## 三、功能模块设计

### 3.1 模块总览

| 模块编号 | 模块名称 | 功能描述 | 优先级 |
|----------|----------|----------|--------|
| M1 | flow-state-spec 更新 | 核心阶段定义规范更新 | P0 |
| M2 | CLAUDE.md 更新 | 项目主文档阶段描述更新 | P0 |
| M3 | README.md 更新 | README 阶段流程图和表格更新 | P0 |
| M4 | Skills 文档更新 | 各 Skill 中的阶段引用更新 | P0 |
| M5 | Wiki 文档更新 | 用户指南、开发指南阶段引用更新 | P1 |
| M6 | ideal-best-practice 同步 | npm 包中的 Skills 同步更新 | P1 |
| M7 | 脚本文件更新 | Python 脚本阶段逻辑更新 | P0 |
| M8 | P15 成果提交阶段定义 | 新增阶段的完整定义 | P0 |

### 3.2 模块详细设计

#### M1: flow-state-spec 更新

**文件路径**: `.claude/skills/ideal-flow-control/references/flow-state-spec.md`

**变更内容**:
1. 更新 `current_phase` 范围：`P1-P16` → `P1-P15`
2. 更新阶段映射表：
   - 删除 P13 上线评审、P14 部署上线
   - P15 维基更新 → P13
   - P16 维基评审 → P14
   - 新增 P15 成果提交
3. 更新收尾阶段状态表格

#### M8: P15 成果提交阶段定义

**新增阶段定义**:

```yaml
P15 成果提交:
  阶段编号: P15
  阶段名称: 成果提交
  执行者: Claude（自动执行）
  触发条件: P14 维基评审通过

  执行内容:
    1. 合并代码到主分支
    2. 删除 Git worktree
    3. 提交 Pull Request
    4. 触发 CI/CD 流水线

  输出:
    - 已合并的代码
    - 已提交的 PR
    - CI/CD 流水线触发状态

  后续动作:
    - CI/CD 自动完成部署上线
```

---

## 四、数据模型

### 4.1 流程状态模型（更新后）

```yaml
# 流程状态.md
---
current_phase: P1-P15           # 更新范围
created_date: {date}
requirement_name: {name}
stories_dir: {path}
---

## 阶段进度

### 规划阶段
| 阶段 | 状态 | 更新时间 |
|------|------|----------|
| P1 需求编写 | {status} | {time} |
| P2 需求评审 | {status} | {time} |
| P3 技术方案 | {status} | {time} |
| P4 方案评审 | {status} | {time} |

### 准备阶段
| 阶段 | 状态 | 更新时间 |
|------|------|----------|
| P5 计划生成 | {status} | {time} |
| P6 计划评审 | {status} | {time} |
| P7 测试用例 | {status} | {time} |
| P8 用例评审 | {status} | {time} |

### 执行阶段
| 阶段 | 状态 | 更新时间 |
|------|------|----------|
| P9 开发执行 | {status} | {time} |
| P10 代码评审 | {status} | {time} |
| P11 测试执行 | {status} | {time} |
| P12 测试评审 | {status} | {time} |

### 收尾阶段
| 阶段 | 状态 | 更新时间 |
|------|------|----------|
| P13 维基更新 | {status} | {time} |
| P14 维基评审 | {status} | {time} |
| P15 成果提交 | {status} | {time} |
```

### 4.2 阶段编号映射表

| 原编号 | 原名称 | 新编号 | 新名称 | 变更类型 |
|--------|--------|--------|--------|----------|
| P1-P12 | 不变 | P1-P12 | 不变 | 无变更 |
| P13 | 上线评审 | - | - | 删除 |
| P14 | 部署上线 | - | - | 删除 |
| P15 | 维基更新 | P13 | 维基更新 | 重新编号 |
| P16 | 维基评审 | P14 | 维基评审 | 重新编号 |
| - | - | P15 | 成果提交 | 新增 |

---

## 五、接口设计

### 5.1 内部接口

| 接口编号 | 接口名称 | 输入 | 输出 | 说明 |
|----------|----------|------|------|------|
| API-1 | 获取当前阶段 | 流程状态文件 | P1-P15 | phase 范围更新 |
| API-2 | 阶段流转 | 当前阶段 + 评审结果 | 下一阶段 | 流转逻辑更新 |
| API-3 | 生成流程状态 | 需求名称 + 日期 | 流程状态文件 | 模板更新 |

### 5.2 脚本接口变更

| 脚本 | 变更内容 |
|------|----------|
| `flow-state.py` | MAX_PHASE = 15, 阶段判断逻辑更新 |
| `generate-flow-status.py` | 模板中阶段列表更新 |

---

## 六、风险分析与应对

### 6.1 主要风险

| 风险项 | 影响程度 | 发生概率 | 应对措施 |
|--------|----------|----------|----------|
| 文档遗漏更新 | 中 | 中 | 建立检查清单，全局搜索验证 |
| 阶段编号不一致 | 高 | 中 | 使用精确匹配，逐文件确认 |
| 脚本逻辑错误 | 中 | 低 | 修改后进行功能测试 |
| 现有迭代不兼容 | 中 | 低 | 提供迁移脚本或手动更新指南 |

### 6.2 风险应对策略

**文档遗漏应对**:
1. 使用 Grep 全局搜索 `P13|P14|P15|P16|16 阶段|十六阶段`
2. 排除 `node_modules/`、`build/` 等构建产物目录
3. 逐个文件确认是否需要更新
4. 建立更新检查清单

**阶段编号不一致应对**:
1. 区分上下文：`P13` 在不同上下文中含义不同
2. 使用精确模式匹配，避免误替换
3. 优先处理核心文件，再处理外围文件

---

## 七、实施计划

### 7.1 阶段划分

| 阶段 | 内容 | 说明 |
|------|------|------|
| 阶段 1 | 更新核心规范 | flow-state-spec.md |
| 阶段 2 | 更新项目文档 | CLAUDE.md, README.md |
| 阶段 3 | 更新 Skills | ideal-*.md 各文件 |
| 阶段 4 | 更新脚本 | Python 脚本阶段逻辑 |
| 阶段 5 | 更新模板 | flow-status.md.tmpl |
| 阶段 6 | 更新 Wiki | 用户指南、开发指南 |
| 阶段 7 | 同步 ideal-best-practice | npm 包中的 Skills |
| 阶段 8 | 验证检查 | 全局搜索确认无遗漏 |

### 7.2 依赖关系

```
阶段 1 (核心规范)
    │
    ├──▶ 阶段 2 (项目文档)
    │
    ├──▶ 阶段 3 (Skills)
    │        │
    │        └──▶ 阶段 4 (脚本)
    │        │
    │        └──▶ 阶段 5 (模板)
    │
    └──▶ 阶段 6 (Wiki)
             │
             └──▶ 阶段 7 (ideal-best-practice)
                      │
                      └──▶ 阶段 8 (验证)
```

---

## 八、参考资料

1. `.claude/skills/ideal-flow-control/references/flow-state-spec.md` - 当前阶段定义规范
2. `CLAUDE.md` - 项目主文档
3. `README.md` - 项目说明
4. P1-需求文档.md - 本次需求文档

---

*文档版本: v1.0*
*创建时间: 2026-02-23*
*作者: Claude Code*
