---
需求名称: ideal-init skill 优化 - 职责重构与功能补全
关联需求: P1-需求文档.md
创建时间: 2026-02-27
当前阶段: P3
---

# P3-技术方案：ideal-init skill 优化 - 职责重构与功能补全

## 一、方案概述

### 1.1 设计目标

重构 `ideal-init` Skill，实现以下目标：

1. **职责清晰化**：Skill 只负责需要 AI 的智能操作，机械操作交由 CLI 处理
2. **功能补全**：实现项目探测、配置生成、CLAUDE.md 追加等核心功能
3. **流程简化**：将 9 步流程精简为 7 步，提升用户体验
4. **文档一致**：确保 SKILL.md 与实际行为完全一致

### 1.2 核心设计原则

| 原则 | 说明 |
|------|------|
| 职责单一 | Skill 只做需要 AI 理解和决策的操作 |
| 用户优先 | 减少用户决策，提供智能默认值 |
| 容错设计 | 探测失败时提供用户修正机制 |
| 文档驱动 | SKILL.md 即规范，实现必须与文档一致 |

### 1.3 技术栈选型

| 层级 | 技术选型 | 选型理由 |
|------|----------|----------|
| 文档格式 | Markdown | 项目统一格式，易于版本管理 |
| 流程定义 | SKILL.md | 复用现有 Skill 架构 |
| 模板引擎 | AI 填充 | 利用 AI 理解上下文能力 |
| 配置输出 | YAML Front Matter | 兼容 Obsidian 和 Claude Code |

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    ideal-init Skill                         │
│                    （7 步智能流程）                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    │
│  │ Step 1      │    │ Step 2      │    │ Step 3      │    │
│  │ 已初始化检测 │───▶│ 项目探测    │───▶│ 用户确认    │    │
│  └─────────────┘    └─────────────┘    └─────────────┘    │
│                            │                    │          │
│                            ▼                    ▼          │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    │
│  │ Step 6      │◀───│ Step 5      │◀───│ Step 4      │    │
│  │ 完整性校验  │    │ CLAUDE.md   │    │ 配置生成    │    │
│  └─────────────┘    └─────────────┘    └─────────────┘    │
│         │                                                  │
│         ▼                                                  │
│  ┌─────────────┐                                          │
│  │ Step 7      │                                          │
│  │ 初始化报告  │                                          │
│  └─────────────┘                                          │
│                                                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    References 目录                           │
├─────────────────────────────────────────────────────────────┤
│  templates/                                                 │
│  ├── project-config.md.tmpl    # 项目配置模板               │
│  └── CLAUDE.md.appendix.md     # CLAUDE.md 追加内容模板     │
│  detection-rules.md            # 项目探测规则               │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构设计

```
.claude/skills/ideal-init/
├── SKILL.md                           # Skill 定义（7 步流程）
└── references/
    ├── templates/
    │   ├── project-config.md.tmpl     # 项目配置模板
    │   └── CLAUDE.md.appendix.md      # CLAUDE.md 追加内容模板
    └── detection-rules.md             # 项目探测规则
```

---

## 三、功能模块设计

### 3.1 模块总览

| 模块编号 | 模块名称 | 功能描述 | 优先级 |
|----------|----------|----------|--------|
| M1 | 已初始化检测 | 检查项目是否已接入工作流 | P0 |
| M2 | 项目探测 | 探测语言、框架、Git 等信息 | P0 |
| M3 | 用户确认 | 展示探测结果，允许用户修正 | P0 |
| M4 | 配置生成 | 生成/优化 project-config.md | P0 |
| M5 | CLAUDE.md 追加 | 在现有文件末尾追加工作流说明 | P1 |
| M6 | 完整性校验 | 检查依赖、配置是否完整 | P1 |
| M7 | 初始化报告 | 输出初始化结果和后续步骤 | P0 |

### 3.2 模块详细设计

#### M1: 已初始化检测

**输入**：项目根目录路径

**处理逻辑**：
1. 检查 `.claude/project-config.md` 是否存在
2. 如果存在，检查是否包含 `CC-Workflow` 标记
3. 如果已初始化，读取初始化时间并提示用户

**输出**：
- 未初始化：进入 M2 项目探测
- 已初始化：询问用户操作（重新配置/取消）

**伪代码**：
```
IF file_exists(".claude/project-config.md") THEN
    content = read_file(".claude/project-config.md")
    IF content contains "CC-Workflow" THEN
        init_time = extract_init_time(content)
        ASK_USER: "检测到已初始化（{init_time}），重新配置/取消？"
        IF user_chooses("重新配置") THEN
            GOTO M2
        ELSE
            EXIT
        END IF
    END IF
END IF
GOTO M2
```

#### M2: 项目探测

**输入**：项目根目录路径

**探测项**：

| 探测项 | 检测方式 | 默认值 |
|--------|----------|--------|
| 项目名称 | package.json.name → Git URL → 目录名 | 目录名 |
| 语言类型 | 特征文件检测 | Other |
| 框架 | 依赖分析 | - |
| Git 状态 | .git 目录检测 | false |
| 主分支 | git rev-parse | main |
| 测试命令 | 推断或读取配置 | - |
| 构建命令 | 推断或读取配置 | - |

**特征文件映射**：

| 特征文件 | 语言 | 测试命令 | 构建命令 |
|----------|------|----------|----------|
| `package.json` | Node.js | `npm test` | `npm run build` |
| `requirements.txt` / `pyproject.toml` | Python | `pytest` | - |
| `go.mod` | Go | `go test ./...` | `go build` |
| `pom.xml` / `build.gradle` | Java | `mvn test` | `mvn package` |

**输出**：探测结果对象

#### M3: 用户确认

**输入**：探测结果对象

**处理逻辑**：
1. 格式化展示探测结果
2. 询问用户是否正确
3. 如果需要修改，逐项收集用户输入

**输出格式**：
```
📊 项目探测结果：

| 项目 | 探测值 |
|------|--------|
| 项目名称 | {name} |
| 语言 | {language} |
| ... |

以上信息是否正确？如需修改请告知。
```

#### M4: 配置生成

**输入**：确认后的探测结果

**处理逻辑**：
1. 读取 `references/templates/project-config.md.tmpl`
2. 填充探测结果到模板
3. 检查文件是否存在
   - 存在：询问覆盖/合并/跳过
   - 不存在：直接创建

**输出**：`.claude/project-config.md` 文件

#### M5: CLAUDE.md 追加

**输入**：项目根目录路径

**处理逻辑**：
1. 检查 `CLAUDE.md` 是否存在
   - 不存在：创建完整文件
   - 存在：检查是否已包含工作流说明
     - 已包含：询问是否更新
     - 未包含：追加内容
2. 读取 `references/templates/CLAUDE.md.appendix.md`
3. 填充时间戳和版本信息
4. 追加到文件末尾

**追加内容模板**：
```markdown
---

## CC-Workflow 工作流集成

本项目已接入 CC-Workflow 工作流体系，实现从需求到上线的全流程自动化。

### 初始化信息

- **初始化时间**：{timestamp}
- **工作流版本**：{version}

### 工作流使用

| 命令 | 说明 |
|------|------|
| `/ideal-requirement` | 开始新需求（P1） |
| `/ideal-init` | 重新初始化项目配置 |
| `ideal status` | 查看当前流程状态 |

### 相关文档

- [项目配置](.claude/project-config.md)
- [流程状态](docs/项目状态.md)
```

#### M6: 完整性校验

**输入**：项目根目录路径

**校验项**：

| 检查项 | 条件 | 处理 |
|--------|------|------|
| project-config.md | 文件存在 | 缺失则警告 |
| CLAUDE.md | 文件存在 | 缺失则警告 |
| docs/迭代/ | 目录存在 | 缺失则提示运行 CLI |
| docs/Wiki/ | 目录存在 | 缺失则提示运行 CLI |
| Git 初始化 | .git 存在 | 未初始化则提示 |

**输出**：校验结果列表

#### M7: 初始化报告

**输入**：所有步骤执行结果

**输出格式**：
```
✓ CC-Workflow 初始化完成

配置文件：
  ✓ 创建 .claude/project-config.md
  ✓ 更新 CLAUDE.md

探测结果：
  项目名称: {name}
  语言: {language}
  ...

完整性校验：
  ✓ project-config.md 存在
  ✓ CLAUDE.md 存在
  ⚠ docs/迭代/ 目录不存在，请运行 `ideal init` 创建

后续步骤：
  1. 检查 .claude/project-config.md 确认配置正确
  2. 运行 /ideal-requirement 开始第一个需求
```

---

## 四、数据模型

### 4.1 核心数据模型

**探测结果对象**：

```typescript
interface DetectionResult {
  // 基本信息
  projectName: string;
  projectRoot: string;

  // 技术栈
  language: 'Node.js' | 'Python' | 'Go' | 'Java' | 'Other';
  framework?: string;
  packageManager?: 'npm' | 'yarn' | 'pnpm' | 'pip' | 'poetry' | 'go mod' | 'maven' | 'gradle';

  // Git 信息
  isGitRepo: boolean;
  gitBranch?: string;
  gitRemoteUrl?: string;

  // 执行命令
  testCommand?: string;
  buildCommand?: string;
  lintCommand?: string;

  // 元信息
  detectedAt: string;
}
```

**初始化状态**：

```typescript
interface InitStatus {
  isInitialized: boolean;
  initializedAt?: string;
  workflowVersion?: string;
}
```

### 4.2 数据流设计

```
用户触发 /ideal-init
        │
        ▼
┌───────────────────┐
│  M1: 已初始化检测  │
│  输出: InitStatus  │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  M2: 项目探测      │
│  输出: DetectionResult │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  M3: 用户确认      │
│  输出: DetectionResult（修正后）│
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  M4: 配置生成      │
│  输出: project-config.md │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  M5: CLAUDE.md 追加 │
│  输出: CLAUDE.md   │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  M6: 完整性校验    │
│  输出: 校验结果列表 │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  M7: 初始化报告    │
│  输出: 用户可见报告 │
└───────────────────┘
```

---

## 五、接口设计

### 5.1 内部接口

| 接口编号 | 接口名称 | 输入 | 输出 | 说明 |
|----------|----------|------|------|------|
| I1 | detectInitStatus | projectRoot | InitStatus | 检测初始化状态 |
| I2 | detectProjectInfo | projectRoot | DetectionResult | 探测项目信息 |
| I3 | confirmWithUser | DetectionResult | DetectionResult | 用户确认修正 |
| I4 | generateConfig | DetectionResult | void | 生成配置文件 |
| I5 | appendClaudeMd | timestamp, version | void | 追加 CLAUDE.md |
| I6 | validateCompleteness | projectRoot | ValidationResult[] | 完整性校验 |
| I7 | generateReport | all results | string | 生成报告 |

### 5.2 外部接口

无外部接口依赖。本 Skill 完全在 Claude Code 环境内执行。

---

## 六、风险分析与应对

### 6.1 主要风险

| 风险项 | 影响程度 | 发生概率 | 应对措施 |
|--------|----------|----------|----------|
| 项目探测不准确 | 中 | 中 | M3 用户确认步骤提供修正机制 |
| CLAUDE.md 追加重复 | 低 | 低 | 检测已有标记避免重复追加 |
| 特征文件缺失 | 低 | 中 | 提供默认值，用户可在 M3 修正 |
| 用户中途取消 | 低 | 中 | 保存已收集信息为草稿 |

### 6.2 风险应对策略

1. **探测不准确**：M3 用户确认步骤是核心保障，允许用户修正任何探测结果
2. **追加重复**：检测 `## CC-Workflow 工作流集成` 标记，已存在则询问更新
3. **特征文件缺失**：使用保守默认值，语言默认 `Other`，命令默认空
4. **中途取消**：可选功能，暂不实现

---

## 七、实施计划

### 7.1 阶段划分

| 阶段 | 内容 | 说明 |
|------|------|------|
| 阶段 1 | 重构 SKILL.md | 简化流程结构，移除 CLI 职责步骤 |
| 阶段 2 | 更新 references/ | 更新探测规则和配置模板 |
| 阶段 3 | 添加 CLAUDE.md 模板 | 创建追加内容模板文件 |
| 阶段 4 | 验证测试 | 模拟执行流程，验证功能完整性 |

### 7.2 依赖关系

```
阶段 1 ──▶ 阶段 2 ──▶ 阶段 3 ──▶ 阶段 4
```

无外部依赖，可顺序实施。

---

## 八、参考资料

| 文档 | 路径 | 说明 |
|------|------|------|
| 现有 SKILL.md | `.claude/skills/ideal-init/SKILL.md` | 当前 9 步流程定义 |
| 需求文档 | `docs/迭代/.../P1-需求文档.md` | 本需求的详细说明 |
| 探测规则 | `.claude/skills/ideal-init/references/detection-rules.md` | 项目探测规则 |
| 配置模板 | `.claude/skills/ideal-init/references/templates/project-config.md.tmpl` | 项目配置模板 |

---

*文档版本: v1.0*
*创建时间: 2026-02-27*
*作者: Claude Code*
