---
story_id: "007"
title: "版本迁移机制（M007）"
status: pending
depends_on: ["006"]
---

# Story 007: 版本迁移机制

## 上下文

### 需求来源
> 来源：P1-需求文档.md#F010：版本迁移机制

**功能描述**：CLI 更新时处理文件重命名和删除，保护用户修改

**核心目标**：
- 版本检测
- 文件迁移（重命名、删除）
- 用户修改保护

### 技术方案
> 来源：P3-技术方案.md#M007：版本迁移机制

**迁移流程**：
1. 读取当前版本
2. 读取目标版本
3. 加载中间版本的迁移清单
4. 生成迁移计划
5. 执行迁移（保护用户修改）

**迁移清单格式**：
```json
{
  "version": "1.1.0",
  "migrations": {
    "renames": [
      { "from": ".claude/hooks/inject.py", "to": ".claude/hooks/inject-context.py" }
    ],
    "deletes": [
      { "path": ".claude/hooks/old-hook.py", "reason": "Replaced by inject-context.py" }
    ]
  }
}
```

### 相关代码

已完成的依赖模块：
- `006-CLI工具.md` - ideal update 命令已实现

## 任务清单

### T007-1：定义迁移清单格式
- [ ] 创建 `src/cli/migrations/manifests/` 目录
- [ ] 定义迁移清单 JSON Schema
- [ ] 定义文件重命名格式（from, to）
- [ ] 定义文件删除格式（path, reason）
- [ ] 定义版本号格式（semver）
- [ ] 创建示例迁移清单 `1.0.0-to-1.1.0.json`
- [ ] 编写格式文档

**JSON Schema**：
```typescript
interface MigrationManifest {
  version: string;           // 目标版本
  from_version: string;      // 源版本
  migrations: {
    renames: Array<{
      from: string;          // 原路径
      to: string;            // 新路径
      hash?: string;         // 预期哈希（用于检测修改）
    }>;
    deletes: Array<{
      path: string;          // 要删除的路径
      reason: string;        // 删除原因
      hash?: string;         // 预期哈希
    }>;
  };
}
```

**验证标准**：
- JSON Schema 正确
- 示例清单可解析
- 文档完整

### T007-2：实现迁移检测
- [ ] 创建 `src/cli/migrations/index.ts`
- [ ] 实现 `detectRequiredMigrations()` 函数
- [ ] 读取当前版本（.ideal/.version）
- [ ] 获取目标版本（内置最新版本）
- [ ] 加载中间版本的所有迁移清单
- [ ] 合并迁移操作
- [ ] 生成迁移计划（MigrationPlan）

**迁移计划格式**：
```typescript
interface MigrationPlan {
  currentVersion: string;
  targetVersion: string;
  renames: Array<{
    from: string;
    to: string;
    userModified: boolean;
  }>;
  deletes: Array<{
    path: string;
    reason: string;
    userModified: boolean;
  }>;
}
```

**验证标准**：
- 正确检测需要迁移的版本
- 正确加载所有中间迁移清单
- 生成完整的迁移计划

### T007-3：实现文件迁移执行
- [ ] 实现 `executeMigration()` 函数
- [ ] 处理文件重命名：
  - 检测用户修改（比较哈希）
  - 未修改：直接重命名
  - 已修改：备份后重命名
- [ ] 处理文件删除：
  - 检测用户修改
  - 未修改：直接删除
  - 已修改：备份后删除或跳过
- [ ] 实现备份机制（创建 .bak 文件）
- [ ] 记录迁移日志

**用户修改检测**：
```typescript
function detectUserModification(filePath: string, expectedHash?: string): boolean {
  if (!expectedHash) return true;  // 无预期哈希，假设已修改
  if (!fs.existsSync(filePath)) return false;  // 文件不存在

  const actualHash = calculateFileHash(filePath);
  return actualHash !== expectedHash;
}
```

**迁移执行逻辑**：
```typescript
function executeRename(from: string, to: string, userModified: boolean): void {
  if (userModified) {
    // 备份原文件
    fs.copyFileSync(from, `${from}.bak`);
    console.log(`[BACKUP] ${from} -> ${from}.bak`);
  }

  // 执行重命名
  fs.renameSync(from, to);
  console.log(`[RENAME] ${from} -> ${to}`);
}

function executeDelete(path: string, reason: string, userModified: boolean): void {
  if (userModified) {
    // 备份
    fs.copyFileSync(path, `${path}.bak`);
    console.log(`[BACKUP] ${path} -> ${path}.bak`);
  }

  // 删除
  fs.unlinkSync(path);
  console.log(`[DELETE] ${path} (reason: ${reason})`);
}
```

**验证标准**：
- 迁移后文件结构正确
- 用户修改被备份
- 迁移日志完整

### T007-4：集成到 ideal update
- [ ] 修改 `src/cli/commands/update.ts`
- [ ] 添加 `--migrate` 参数
- [ ] 在文件更新前检测迁移需求
- [ ] 显示迁移计划预览
- [ ] 确认后执行迁移
- [ ] 生成迁移报告

**迁移报告格式**：
```
Migration Report (1.0.0 -> 1.1.0)
================================

Renames:
  ✓ .claude/hooks/inject.py -> .claude/hooks/inject-context.py
  ⚠ .ideal/config.yaml -> .ideal/worktree.yaml (user modified, backed up)

Deletes:
  ✓ .claude/hooks/old-hook.py (reason: Replaced by inject-context.py)

Summary:
  - 2 files renamed
  - 1 file deleted
  - 1 backup created
```

**验证标准**：
- ideal update --migrate 正确执行迁移
- 迁移报告清晰
- 用户可选择跳过迁移

## 验收标准

### 功能验收
- [ ] 迁移清单格式完整
- [ ] 迁移检测正确
- [ ] 文件迁移执行正确
- [ ] 用户修改被保护
- [ ] 集成到 ideal update

### 代码质量
- [ ] TypeScript 无编译错误
- [ ] 代码有完整注释
- [ ] 错误处理完善
- [ ] 日志记录完整

## 实现笔记

<!-- 由 Claude 在执行过程中填写 -->
