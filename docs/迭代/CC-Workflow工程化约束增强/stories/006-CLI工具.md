---
story_id: "006"
title: "CLI 工具（M006）"
status: pending
depends_on: ["001", "004"]
---

# Story 006: CLI 工具

## 上下文

### 需求来源
> 来源：P1-需求文档.md#F009：CLI 工具

**命令清单**：

| 命令 | 功能 |
|------|------|
| `ideal init` | 初始化项目结构（.ideal/ 目录、配置文件、Hook 脚本） |
| `ideal update` | 更新模板文件和 Hook 脚本到最新版本 |
| `ideal worktree list` | 列出所有 Worktree |
| `ideal worktree create <需求名>` | 手动创建 Worktree |
| `ideal worktree remove <需求名>` | 手动删除 Worktree |

### 技术方案
> 来源：P3-技术方案.md#M006：CLI 工具

**技术栈**：
- Node.js + TypeScript
- npm 分发
- 跨平台兼容

**目录结构**：
```
src/
├── cli/
│   ├── index.ts           # CLI 入口
│   └── commands/
│       ├── init.ts        # init 命令
│       ├── update.ts      # update 命令
│       └── worktree.ts    # worktree 命令
```

### 相关代码

已完成的依赖模块：
- `001-Hook自动注入.md` - Hook 脚本已实现
- `004-Worktree生命周期.md` - Worktree 脚本已实现

## 任务清单

### T006-1：初始化 CLI 项目
- [ ] 创建 `package.json`（name: @anthropic/ideal-cli）
- [ ] 配置 TypeScript（tsconfig.json）
- [ ] 配置构建脚本（npm run build）
- [ ] 配置 bin 入口（ideal）
- [ ] 创建 `src/cli/index.ts` 入口文件
- [ ] 实现命令行参数解析
- [ ] 实现 --help 和 --version 输出

**package.json 关键配置**：
```json
{
  "name": "@anthropic/ideal-cli",
  "version": "1.0.0",
  "bin": {
    "ideal": "./dist/cli/index.js"
  },
  "scripts": {
    "build": "tsc",
    "prepublishOnly": "npm run build"
  }
}
```

**验证标准**：
- npm install 成功
- npm run build 成功
- ideal --help 输出帮助信息
- ideal --version 输出版本号

### T006-2：实现 ideal init
- [ ] 创建 `src/cli/commands/init.ts`
- [ ] 解析命令行参数（-y 跳过确认, -u <name> 指定用户名）
- [ ] 检测当前目录是否为 Git 仓库
- [ ] 创建 `.ideal/` 目录
- [ ] 创建 `.ideal/worktree.yaml` 模板
- [ ] 创建 `.ideal/.version` 文件
- [ ] 创建 `.claude/hooks/` 目录
- [ ] 复制 `inject-context.py` 模板
- [ ] 复制 `verify-loop.py` 模板
- [ ] 创建/更新 `.claude/settings.json`
- [ ] 输出初始化成功信息

**目录结构创建**：
```
.ideal/
├── worktree.yaml
├── .version
└── .current-task (空文件)

.claude/
├── hooks/
│   ├── inject-context.py
│   └── verify-loop.py
└── settings.json
```

**验证标准**：
- ideal init 创建完整的目录结构
- 所有文件正确生成
- 文件权限正确（.sh 可执行）

### T006-3：实现 ideal update
- [ ] 创建 `src/cli/commands/update.ts`
- [ ] 解析命令行参数（--dry-run 预览, -f 强制覆盖）
- [ ] 读取当前版本号（.ideal/.version）
- [ ] 获取最新版本号（从 npm 或内置）
- [ ] 比较版本，判断是否需要更新
- [ ] 计算模板文件哈希
- [ ] 对比用户修改（哈希不一致则用户修改过）
- [ ] 处理文件更新策略：
  - 未修改：直接覆盖
  - 已修改：提示用户选择（跳过/覆盖/备份）
- [ ] 更新版本号
- [ ] 生成更新报告

**更新策略**：
```typescript
interface UpdateStrategy {
  unchanged: string[];    // 直接覆盖
  modified: string[];     // 需要用户确认
  added: string[];        // 新增文件
  deleted: string[];      // 已删除文件
}
```

**验证标准**：
- ideal update --dry-run 显示变更预览
- ideal update 正确更新文件
- 用户修改被保留或提示确认

### T006-4：实现 ideal worktree list
- [ ] 创建 `src/cli/commands/worktree.ts`（list 子命令）
- [ ] 执行 `git worktree list --porcelain`
- [ ] 解析输出
- [ ] 格式化为表格输出
- [ ] 显示 Worktree 路径、分支、状态

**输出格式**：
```
Worktree List:
┌──────────────────────────────────────────────────────────────┐
│ Path                                   │ Branch          │ Status  │
├──────────────────────────────────────────────────────────────┤
│ /path/to/main                          │ main            │ active  │
│ /path/to/worktrees/feature/user-auth   │ feature/user-auth│ pristine│
└──────────────────────────────────────────────────────────────┘
```

**验证标准**：
- 正确列出所有 Worktree
- 输出格式清晰
- 显示正确的状态

### T006-5：实现 ideal worktree create/remove
- [ ] 在 `src/cli/commands/worktree.ts` 添加 create 子命令
- [ ] 在 `src/cli/commands/worktree.ts` 添加 remove 子命令
- [ ] create：验证需求名称参数
- [ ] create：调用 worktree-create.sh 脚本
- [ ] create：显示创建成功信息
- [ ] remove：验证需求名称参数
- [ ] remove：调用 worktree-remove.sh 脚本
- [ ] remove：显示删除成功信息
- [ ] 错误处理和提示

**调用脚本**：
```typescript
// create
const result = execSync(`./.claude/scripts/worktree-create.sh ${name}`, {
  cwd: process.cwd(),
  encoding: 'utf-8'
});

// remove
const result = execSync(`./.claude/scripts/worktree-remove.sh ${name}`, {
  cwd: process.cwd(),
  encoding: 'utf-8'
});
```

**验证标准**：
- ideal worktree create 正确创建
- ideal worktree remove 正确删除
- 错误信息清晰

## 验收标准

### 功能验收
- [ ] ideal --help 显示帮助
- [ ] ideal init 创建完整结构
- [ ] ideal update 正确更新
- [ ] ideal worktree list 正确列出
- [ ] ideal worktree create/remove 正确执行

### 代码质量
- [ ] TypeScript 无编译错误
- [ ] 代码有完整注释
- [ ] 错误处理完善
- [ ] 跨平台兼容（Windows/macOS/Linux）

## 实现笔记

<!-- 由 Claude 在执行过程中填写 -->
