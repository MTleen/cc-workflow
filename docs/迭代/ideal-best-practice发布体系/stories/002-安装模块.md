---
story_id: 002
title: 安装模块 - 跨平台安装脚本
status: pending
depends_on: [001]
---

# Story 002: 安装模块 - 跨平台安装脚本

## 上下文

### 需求来源
> 来源：P1-需求文档.md#三、功能需求

**F004 install.sh 安装脚本**：Unix 系统一键安装，支持指定包名和版本

**F005 install.ps1 安装脚本**：Windows 系统一键安装，功能同上

### 技术方案
> 来源：P3-技术方案.md#五、功能模块设计

**安装流程：**
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 参数解析    │────►│ 环境检测    │────►│ 获取包信息  │
│ (包名/版本) │     │ (curl/网络) │     │(fetch reg)  │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 显示完成    │◄────│ 注册到      │◄────│ 复制文件    │
│ 信息        │     │ Claude Code │     │ 到目标目录  │
└─────────────┘     └─────────────┘     └─────────────┘
```

**错误处理策略：**

| 错误类型 | 处理方式 |
|----------|----------|
| 网络不可达 | 提示检查网络，退出码 1 |
| 包不存在 | 列出可用包，退出码 2 |
| 版本不存在 | 列出可用版本，退出码 3 |
| 目标目录权限不足 | 提示使用 sudo/管理员权限，退出码 4 |
| 文件复制失败 | 回滚已复制文件，退出码 5 |

### 相关代码

依赖模块：
- `ideal-best-practice/registry.json` - Story 001 创建
- `ideal-best-practice/packages/ideal-dev/` - Story 001 创建

---

## 任务清单

- [ ] **任务 1**: 开发 install.sh 核心框架
  - [ ] 定义脚本头部（shebang, 描述, 版本）
  - [ ] 实现参数解析（getopts）
  - [ ] 实现 --help/-h 帮助信息
  - [ ] 实现 --list/-l 列出可用包
  - [ ] 实现 --verbose/-v 详细输出
  - [ ] 实现 --dry-run 模拟安装

- [ ] **任务 2**: 实现网络请求和包获取
  - [ ] 实现 fetch_registry 函数
  - [ ] 实现 fetch_manifest 函数
  - [ ] 添加 curl/wget 检测
  - [ ] 添加网络超时处理
  - [ ] 添加 JSON 解析（使用 jq 或 python）

- [ ] **任务 3**: 实现文件下载和安装
  - [ ] 实现 download_package 函数
  - [ ] 实现 install_skills 函数
  - [ ] 实现 install_agents 函数
  - [ ] 添加目录创建逻辑
  - [ ] 添加文件权限处理

- [ ] **任务 4**: 实现错误处理和回滚
  - [ ] 定义错误码常量
  - [ ] 实现 error_exit 函数
  - [ ] 实现 rollback 函数
  - [ ] 添加错误信息输出
  - [ ] 添加安装日志

- [ ] **任务 5**: 开发 install.ps1（Windows 版本）
  - [ ] 转换参数解析为 PowerShell
  - [ ] 实现 Invoke-WebRequest 下载
  - [ ] 实现 Windows 路径处理
  - [ ] 实现错误处理
  - [ ] 添加执行策略提示

- [ ] **任务 6**: 测试跨平台兼容性
  - [ ] macOS 测试
  - [ ] Linux 测试
  - [ ] Windows 测试
  - [ ] 记录测试结果

---

## 验收标准

### 功能验收
- [ ] `./install.sh --help` 显示帮助信息
- [ ] `./install.sh --list` 显示可用包列表
- [ ] `./install.sh ideal-dev` 成功安装
- [ ] `./install.sh ideal-dev@1.0.0` 指定版本安装
- [ ] `./install.sh nonexistent` 返回错误码 2
- [ ] Windows 版本功能对等

### 代码质量
- [ ] Shell 脚本通过 shellcheck 检查
- [ ] PowerShell 脚本语法正确
- [ ] 错误信息清晰易懂
- [ ] 代码注释充分

---

## 实现笔记

<!-- 由 Claude 在执行过程中填写 -->
