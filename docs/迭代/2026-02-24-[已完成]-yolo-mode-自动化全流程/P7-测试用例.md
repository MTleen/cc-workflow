# P7-测试用例

## 概述

| 项目 | 内容 |
|------|------|
| 需求名称 | YOLO 模式 - 自动化全流程执行 |
| 编码计划 | P5-编码计划.md |
| 生成日期 | 2026-02-24 |

---

## 用例统计

| 类型 | 数量 | 占比 |
|------|------|------|
| 功能测试 | 12 | 55% |
| 边界测试 | 5 | 23% |
| 异常测试 | 5 | 23% |
| **总计** | 22 | 100% |

---

## 功能测试用例

### TC-F-001: YOLO 模式触发

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-001 |
| **用例名称** | P2 评审通过后询问用户是否启用 YOLO 模式 |
| **优先级** | P0 |
| **关联模块** | M3 (模式控制) |
| **前置条件** | P2 需求评审已通过 |

**测试步骤**:
1. 完成 P2 需求评审
2. 系统检测到 P2 状态为 approved
3. 观察系统行为

**预期结果**:
- 系统询问用户："是否启用 YOLO 模式自动执行后续阶段（P3-P14）？"
- 提供两个选项："是" 和 "否"

---

### TC-F-002: 用户选择启用 YOLO 模式

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-002 |
| **用例名称** | 用户选择"是"启用 YOLO 模式 |
| **优先级** | P0 |
| **关联模块** | M3 (模式控制), M1 (状态管理) |
| **前置条件** | P2 评审已通过，系统已询问是否启用 YOLO |

**测试步骤**:
1. 用户选择"是"
2. 观察流程状态文件变化
3. 观察系统启动自动执行

**预期结果**:
- 流程状态.md 中 `yolo_mode.enabled` 更新为 `true`
- 流程状态.md 中 `yolo_mode.status` 更新为 `in_progress`
- 系统开始执行 P3 阶段

---

### TC-F-003: 用户选择不启用 YOLO 模式

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-003 |
| **用例名称** | 用户选择"否"继续传统流程 |
| **优先级** | P0 |
| **关联模块** | M3 (模式控制) |
| **前置条件** | P2 评审已通过，系统已询问是否启用 YOLO |

**测试步骤**:
1. 用户选择"否"
2. 观察流程状态文件变化
3. 观察系统行为

**预期结果**:
- 流程状态.md 中 `yolo_mode.enabled` 保持为 `false`
- 系统继续传统的人工评审流程
- 等待用户手动触发 P3

---

### TC-F-004: 自动执行 P3-P14 阶段

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-004 |
| **用例名称** | YOLO 模式自动执行完整流程 |
| **优先级** | P0 |
| **关联模块** | M5 (阶段编排), M6 (Ralph Loop) |
| **前置条件** | YOLO 模式已启用 |

**测试步骤**:
1. 启用 YOLO 模式
2. 系统依次执行 P3-P14
3. 观察每个阶段的执行和状态更新

**预期结果**:
- 系统按顺序执行：P3→P4→P5→P6→P7→P8→P9→P10→P11→P12→P13→P14
- 每个阶段完成后，`completed_phases` 列表更新
- 流程状态.md 中 `current_phase` 正确更新

---

### TC-F-005: 流程状态文件正确更新

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-005 |
| **用例名称** | 每个阶段完成后状态文件正确更新 |
| **优先级** | P0 |
| **关联模块** | M1 (状态管理) |
| **前置条件** | YOLO 模式已启用，正在执行阶段 |

**测试步骤**:
1. 等待任意阶段完成
2. 读取流程状态.md
3. 验证状态字段

**预期结果**:
- `current_phase` 更新为当前阶段
- `last_update` 更新为最新时间戳
- 已完成阶段添加到 `completed_phases`
- `audit_logs` 添加新日志条目

---

### TC-F-006: 自动评审生成完整意见

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-006 |
| **用例名称** | 自动评审生成评审意见和修改建议 |
| **优先级** | P0 |
| **关联模块** | M4 (自动评审) |
| **前置条件** | 执行阶段完成，进入评审阶段 |

**测试步骤**:
1. 完成执行阶段（如 P3）
2. 触发自动评审（P4）
3. 检查评审日志

**预期结果**:
- 生成评审日志文件（如 review-P4.log）
- 日志包含评审意见（comments）
- 日志包含修改建议（suggestions）
- 日志包含通过/不通过判定（passed）

---

### TC-F-007: 评审不通过自动修复重试

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-007 |
| **用例名称** | 评审不通过时自动修复并重新评审 |
| **优先级** | P0 |
| **关联模块** | M4 (自动评审), M5 (阶段编排) |
| **前置条件** | 执行阶段完成，评审不通过 |

**测试步骤**:
1. 模拟评审不通过场景
2. 观察系统行为
3. 验证重试机制

**预期结果**:
- 系统生成修改建议
- 系统自动执行修复
- 系统重新进行评审
- `current_attempt` 计数器递增

---

### TC-F-008: 审计日志完整记录

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-008 |
| **用例名称** | 审计日志记录完整执行过程 |
| **优先级** | P0 |
| **关联模块** | M2 (审计日志) |
| **前置条件** | YOLO 模式执行过程中 |

**测试步骤**:
1. 执行任意阶段
2. 检查 yolo-logs 目录
3. 验证日志内容

**预期结果**:
- 生成阶段日志文件（phase-P{x}.log）
- 生成评审日志文件（review-P{x}.log）
- 日志包含执行时间戳
- 日志包含 Token 消耗统计
- 日志包含执行结果

---

### TC-F-009: P15 等待用户确认

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-009 |
| **用例名称** | P15 阶段正确等待用户确认 |
| **优先级** | P0 |
| **关联模块** | M5 (阶段编排) |
| **前置条件** | P14 已完成 |

**测试步骤**:
1. 完成 P14 阶段
2. 观察系统行为
3. 验证不会自动继续

**预期结果**:
- 系统暂停执行
- 流程状态.md 中 `current_phase` 为 P15
- 等待用户手动确认
- 不自动执行后续操作

---

### TC-F-010: YOLO 模式完整执行流程

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-010 |
| **用例名称** | 从 P2 到 P15 完整流程验证 |
| **优先级** | P0 |
| **关联模块** | 全部 |
| **前置条件** | P2 评审已通过 |

**测试步骤**:
1. 启用 YOLO 模式
2. 等待自动执行完成
3. 在 P15 确认
4. 验证最终状态

**预期结果**:
- P3-P14 全部完成
- 所有日志文件生成
- 流程状态.md 中 `yolo_mode.status` 为 `completed`
- `completed_phases` 包含 P3-P14

---

### TC-F-011: 生成执行摘要日志

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-011 |
| **用例名称** | 生成 summary.log 执行摘要 |
| **优先级** | P1 |
| **关联模块** | M2 (审计日志) |
| **前置条件** | YOLO 模式执行过程中或完成后 |

**测试步骤**:
1. 执行多个阶段
2. 检查 yolo-logs/summary.log
3. 验证摘要内容

**预期结果**:
- summary.log 文件存在
- 包含已完成阶段列表
- 包含各阶段状态表格
- 包含生成时间

---

### TC-F-012: 状态持久化正确性

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-F-012 |
| **用例名称** | 状态文件读写正确性验证 |
| **优先级** | P0 |
| **关联模块** | M1 (状态管理) |
| **前置条件** | 无 |

**测试步骤**:
1. 调用 save_yolo_state 保存状态
2. 调用 load_yolo_state 读取状态
3. 验证数据一致性

**预期结果**:
- 保存的状态与读取的状态一致
- YAML frontmatter 格式正确
- 所有字段完整保留

---

## 边界测试用例

### TC-B-001: 评审失败阈值边界

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-B-001 |
| **用例名称** | 连续 3 次评审失败触发熔断 |
| **优先级** | P0 |
| **边界类型** | 状态边界 |
| **关联模块** | M7 (熔断机制) |
| **前置条件** | YOLO 模式已启用 |

**测试步骤**:
1. 模拟第 1 次评审失败
2. 模拟第 2 次评审失败
3. 模拟第 3 次评审失败
4. 观察系统行为

**预期结果**:
- 第 1-2 次失败：继续重试
- 第 3 次失败：触发熔断
- 流程状态.md 中 `circuit_breaker.triggered` 为 `true`
- 系统暂停执行

**边界值**:
| 参数 | 最小值 | 最大值 | 测试值 |
|------|--------|--------|--------|
| 连续失败次数 | 1 | 3 | 1, 2, 3 |

---

### TC-B-002: 测试通过率边界

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-B-002 |
| **用例名称** | 测试通过率 80% 边界验证 |
| **优先级** | P0 |
| **边界类型** | 输入边界 |
| **关联模块** | M7 (熔断机制) |
| **前置条件** | 执行测试阶段 |

**测试步骤**:
1. 模拟通过率 = 81%（不触发）
2. 模拟通过率 = 80%（边界）
3. 模拟通过率 = 79%（触发）
4. 观察系统行为

**预期结果**:
- 通过率 ≥ 80%：继续执行
- 通过率 < 80%：触发熔断
- 记录失败用例

**边界值**:
| 参数 | 最小值 | 最大值 | 测试值 |
|------|--------|--------|--------|
| 通过率 | 0% | 100% | 79%, 80%, 81% |

---

### TC-B-003: 重复错误次数边界

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-B-003 |
| **用例名称** | 同一错误重复 5 次触发熔断 |
| **优先级** | P0 |
| **边界类型** | 状态边界 |
| **关联模块** | M7 (熔断机制) |
| **前置条件** | YOLO 模式已启用 |

**测试步骤**:
1. 模拟同一错误出现 1-4 次
2. 模拟同一错误出现第 5 次
3. 观察系统行为

**预期结果**:
- 错误次数 1-4：继续执行
- 错误次数 5：触发熔断
- 记录错误详情

**边界值**:
| 参数 | 最小值 | 最大值 | 测试值 |
|------|--------|--------|--------|
| 重复错误次数 | 1 | 5 | 4, 5, 6 |

---

### TC-B-004: 单阶段执行时间边界

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-B-004 |
| **用例名称** | 单阶段执行时间 30 分钟边界 |
| **优先级** | P1 |
| **边界类型** | 流程边界 |
| **关联模块** | M6 (Ralph Loop) |
| **前置条件** | YOLO 模式执行中 |

**测试步骤**:
1. 模拟执行时间 = 29 分钟
2. 模拟执行时间 = 30 分钟
3. 模拟执行时间 = 31 分钟
4. 观察系统行为

**预期结果**:
- ≤ 30 分钟：正常完成
- > 30 分钟：触发超时熔断
- 记录当前进度

**边界值**:
| 参数 | 最小值 | 最大值 | 测试值 |
|------|--------|--------|--------|
| 执行时间(分钟) | 0 | 30 | 29, 30, 31 |

---

### TC-B-005: 空状态边界测试

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-B-005 |
| **用例名称** | 初始状态和空状态处理 |
| **优先级** | P1 |
| **边界类型** | 状态边界 |
| **关联模块** | M1 (状态管理) |
| **前置条件** | 流程状态文件不存在或为空 |

**测试步骤**:
1. 流程状态文件不存在
2. 调用 load_yolo_state
3. 验证返回默认值

**预期结果**:
- 返回默认的 YoloModeConfig
- enabled = false
- status = pending
- completed_phases = []

---

## 异常测试用例

### TC-E-001: 状态文件损坏恢复

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-E-001 |
| **用例名称** | 流程状态文件损坏时的处理 |
| **优先级** | P0 |
| **异常类型** | 状态错误 |
| **关联模块** | M1 (状态管理), M8 (中断恢复) |
| **前置条件** | 流程状态文件存在但损坏 |

**测试步骤**:
1. 创建损坏的流程状态文件（无效 YAML）
2. 尝试加载状态
3. 观察系统行为

**预期结果**:
- 系统返回错误码: INVALID_STATE_FILE
- 错误消息: "流程状态文件格式无效"
- 系统状态: 返回默认配置或提示用户修复

---

### TC-E-002: Ralph Loop 进程异常终止

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-E-002 |
| **用例名称** | Ralph Loop 进程异常终止后的恢复 |
| **优先级** | P0 |
| **异常类型** | 外部错误 |
| **关联模块** | M6 (Ralph Loop), M8 (中断恢复) |
| **前置条件** | YOLO 模式执行中 |

**测试步骤**:
1. YOLO 模式执行到 P5 阶段
2. 强制终止 Ralph Loop 进程
3. 重新启动恢复
4. 观察系统行为

**预期结果**:
- 检测到中断状态
- 从 P5 阶段继续执行
- 不重复执行已完成的阶段
- 记录恢复事件

---

### TC-E-003: 熔断后手动恢复

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-E-003 |
| **用例名称** | 熔断触发后用户手动恢复 |
| **优先级** | P0 |
| **异常类型** | 状态错误 |
| **关联模块** | M7 (熔断机制), M8 (中断恢复) |
| **前置条件** | 熔断已触发 |

**测试步骤**:
1. 触发熔断（如连续 3 次评审失败）
2. 用户查看日志，了解问题
3. 用户修复问题
4. 用户执行恢复命令
5. 观察系统行为

**预期结果**:
- 熔断状态清除
- 从中断点继续执行
- 重试计数器重置
- 记录恢复事件

---

### TC-E-004: 无效的流程状态更新

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-E-004 |
| **用例名称** | 更新流程状态时传入无效参数 |
| **优先级** | P1 |
| **异常类型** | 输入错误 |
| **关联模块** | M1 (状态管理) |
| **前置条件** | 无 |

**测试步骤**:
1. 调用 save_yolo_state 传入 None
2. 调用 update_phase_status 传入无效阶段编号
3. 观察系统行为

**预期结果**:
- 系统返回错误码: INVALID_PARAMETER
- 错误消息: "无效的参数"
- 系统状态: 不更新流程状态文件

---

### TC-E-005: 日志文件写入失败

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-E-005 |
| **用例名称** | 日志目录无写入权限 |
| **优先级** | P2 |
| **异常类型** | 外部错误 |
| **关联模块** | M2 (审计日志) |
| **前置条件** | yolo-logs 目录权限不足 |

**测试步骤**:
1. 设置 yolo-logs 目录为只读
2. 执行阶段并尝试写入日志
3. 观察系统行为

**预期结果**:
- 系统返回错误码: LOG_WRITE_FAILED
- 错误消息: "无法写入日志文件"
- 系统状态: 继续执行但记录警告

---

## 覆盖率报告

### 功能覆盖

| 模块 | 功能点 | 用例数 | 覆盖率 |
|------|--------|--------|--------|
| M1 | 状态管理 | 3 | 100% |
| M2 | 审计日志 | 2 | 100% |
| M3 | 模式控制 | 3 | 100% |
| M4 | 自动评审 | 2 | 100% |
| M5 | 阶段编排 | 3 | 100% |
| M6 | Ralph Loop | 2 | 100% |
| M7 | 熔断机制 | 3 | 100% |
| M8 | 中断恢复 | 2 | 100% |
| **总计** | - | 22 | 100% |

### 优先级分布

| 优先级 | 数量 | 说明 |
|--------|------|------|
| P0 | 16 | 核心功能，必须通过 |
| P1 | 4 | 重要功能，应该通过 |
| P2 | 2 | 次要功能，可延后 |

### 验收标准覆盖

| 验收标准 | 对应用例 | 覆盖状态 |
|----------|----------|----------|
| P2 评审通过后询问用户 | TC-F-001 | ✅ |
| 自动执行 P3-P14 | TC-F-004, TC-F-010 | ✅ |
| 流程状态文件正确更新 | TC-F-005, TC-F-012 | ✅ |
| 自动评审生成意见 | TC-F-006 | ✅ |
| 评审不通过自动修复 | TC-F-007 | ✅ |
| 连续 3 次失败暂停 | TC-B-001 | ✅ |
| 测试通过率 < 80% 暂停 | TC-B-002 | ✅ |
| 重复错误 5 次暂停 | TC-B-003 | ✅ |
| 中断后自动恢复 | TC-E-002, TC-E-003 | ✅ |
| 审计日志完整记录 | TC-F-008, TC-F-011 | ✅ |
| P15 等待用户确认 | TC-F-009 | ✅ |

---

*文档版本: v1.0*
*生成时间: 2026-02-24*
*作者: Claude Code*
