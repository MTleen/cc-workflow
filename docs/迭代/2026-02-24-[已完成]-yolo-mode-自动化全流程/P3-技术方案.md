---
需求名称: YOLO 模式 - 自动化全流程执行
关联需求: P1-需求文档.md
创建时间: 2026-02-24
当前阶段: P3
---

# P3-技术方案：YOLO 模式 - 自动化全流程执行

## 一、方案概述

### 1.1 设计目标

本方案旨在为 Claude Code 中心化团队工作流新增 YOLO 模式，实现以下设计目标：

| 目标 | 描述 | 优先级 |
|------|------|--------|
| 自动化执行 | P2 评审通过后，P3-P14 阶段由大模型自动执行 | P0 |
| 质量保障 | 自动评审机制确保各阶段输出质量 | P0 |
| 可靠性保障 | 中断自动恢复，熔断机制防止无限循环 | P0 |
| 可追溯性 | 完整审计日志记录执行过程 | P0 |
| 用户体验 | 最小化人工干预，仅在 P15 需要确认 | P1 |

### 1.2 核心设计原则

| 原则 | 说明 |
|------|------|
| 复用优先 | 复用现有 Skills 和 Agents，不重复造轮子 |
| 简单优先 | 采用最简单的实现方案，避免过度设计 |
| 状态驱动 | 所有关键状态持久化，支持断点续传 |
| 渐进增强 | 先实现核心功能，后续迭代优化 |

### 1.3 技术栈选型

| 层级 | 技术选型 | 选型理由 |
|------|----------|----------|
| 编排层 | ideal-yolo Skill | 新增 Skill，负责阶段编排和调度 |
| 执行引擎 | Ralph Loop (项目内嵌入) | 成熟的自动化执行方案，支持中断恢复 |
| 状态存储 | 流程状态.md (YAML 扩展) | 与现有系统集成，Git 友好 |
| 日志记录 | Markdown 文件 | 可读性好，便于用户查阅 |
| 熔断机制 | Shell 脚本 | 简单可靠，易于调试 |

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层                                          │
│                                                                              │
│   用户交互: P1 需求输入 → P2 评审 → [YOLO 模式选择] → P15 最终确认          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ideal-yolo Skill                                   │
│                           (编排层 - 新增)                                    │
│                                                                              │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│   │ 模式控制    │  │ 阶段编排    │  │ 状态管理    │  │ 熔断机制    │       │
│   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                              │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│   │ Ralph Loop  │  │ 自动评审    │  │ 审计日志    │  │ 中断恢复    │       │
│   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           现有 Skills (执行层)                               │
│                                                                              │
│   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐               │
│   │ P3        │→ │ P4        │→ │ P5        │→ │ P6        │               │
│   │ 方案生成  │  │ 自动评审  │  │ 计划生成  │  │ 自动评审  │               │
│   └───────────┘  └───────────┘  └───────────┘  └───────────┘               │
│         │              │              │              │                     │
│         ▼              ▼              ▼              ▼                     │
│   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐               │
│   │ P7        │→ │ P8        │→ │ P9        │→ │ P10       │               │
│   │ 测试用例  │  │ 自动评审  │  │ 开发执行  │  │ 自动评审  │               │
│   └───────────┘  └───────────┘  └───────────┘  └───────────┘               │
│         │              │              │              │                     │
│         ▼              ▼              ▼              ▼                     │
│   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐               │
│   │ P11       │→ │ P12       │→ │ P13       │→ │ P14       │               │
│   │ 测试执行  │  │ 自动评审  │  │ 维基更新  │  │ 自动评审  │               │
│   └───────────┘  └───────────┘  └───────────┘  └───────────┘               │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Agents (能力层)                                    │
│                                                                              │
│   architect  │  pm  │  qa  │  implement  │  check  │  debug  │  tech-writer │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据层                                             │
│                                                                              │
│   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│   │ 流程状态.md     │  │ yolo-logs/      │  │ .claude/ralph/  │            │
│   │ (状态持久化)    │  │ (审计日志)      │  │ (执行引擎)      │            │
│   └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构设计

```
.claude/
├── skills/
│   └── ideal-yolo/               # 新增 YOLO 模式 Skill
│       ├── SKILL.md              # Skill 定义
│       ├── references/
│       │   ├── phase-orchestrator.md    # 阶段编排规范
│       │   ├── review-standards.md      # 自动评审标准
│       │   ├── circuit-breaker.md       # 熔断机制规范
│       │   └── recovery-protocol.md     # 恢复协议
│       ├── templates/
│       │   ├── yolo-prompt.md           # Ralph Loop 提示模板
│       │   └── audit-log.md             # 审计日志模板
│       └── scripts/
│           ├── yolo-state.py            # 状态管理脚本
│           └── yolo-resume.py           # 恢复执行脚本
│
├── ralph/                        # Ralph Loop 集成
│   ├── ralph-loop.sh             # 循环执行脚本
│   ├── PROMPT.md                 # 动态生成的执行提示
│   ├── STATE.json                # 执行状态快照
│   └── hooks/                    # 阶段钩子
│       ├── pre-phase.sh
│       ├── post-phase.sh
│       └── on-error.sh
│
└── project-config.md             # 项目配置（扩展）

docs/迭代/{需求名}/
├── P1-需求文档.md
├── P3-技术方案.md
├── 流程状态.md                   # 扩展 YOLO 模式字段
└── yolo-logs/                    # 新增审计日志目录
    ├── manifest.json             # 日志索引
    ├── phase-P3.log              # 阶段执行日志
    ├── review-P4.log             # 自动评审日志
    └── summary.log               # 执行摘要
```

---

## 三、功能模块设计

### 3.1 模块总览

| 模块编号 | 模块名称 | 功能描述 | 优先级 |
|----------|----------|----------|--------|
| M001 | 模式控制 | YOLO 模式启用/禁用/切换 | P0 |
| M002 | 阶段编排 | P3-P14 阶段调度和执行 | P0 |
| M003 | 状态管理 | 流程状态读写和持久化 | P0 |
| M004 | Ralph Loop 集成 | 执行引擎调用和监控 | P0 |
| M005 | 自动评审 | 各阶段自动评审逻辑 | P0 |
| M006 | 审计日志 | 执行过程记录和存储 | P0 |
| M007 | 熔断机制 | 异常检测和暂停处理 | P0 |
| M008 | 中断恢复 | 断点续传和状态恢复 | P1 |

### 3.2 模块详细设计

#### M001 模式控制

**职责**：管理 YOLO 模式的启用、禁用和切换

**接口**：
```yaml
# 启用 YOLO 模式
enable_yolo(requirement_dir: str) -> bool

# 禁用 YOLO 模式（降级到传统模式）
disable_yolo(requirement_dir: str) -> bool

# 检查 YOLO 模式状态
check_yolo_status(requirement_dir: str) -> YoloStatus
```

**状态机**：
```
pending → in_progress → paused → in_progress
                 ↓
            completed
                 ↓
                  error
```

#### M002 阶段编排

**职责**：按顺序调度和执行 P3-P14 阶段

**编排规则**：
| 当前阶段 | 执行 Skill | 评审阶段 | 评审方式 |
|----------|-----------|----------|----------|
| P3 | ideal-dev-solution | P4 | 自动评审 |
| P5 | ideal-dev-plan | P6 | 自动评审 |
| P7 | ideal-test-case | P8 | 自动评审 |
| P9 | ideal-dev-exec | P10 | 自动评审 |
| P11 | ideal-test-exec | P12 | 自动评审 |
| P13 | ideal-wiki | P14 | 自动评审 |

**执行流程**：
```
for phase in [P3, P5, P7, P9, P11, P13]:
    execute_skill(phase)
    result = auto_review(phase + 1)
    if not result.passed:
        retry_or_circuit_break()
    log_audit(phase, result)
```

#### M003 状态管理

**职责**：读写和持久化流程状态

**状态文件扩展**：
```yaml
yolo_mode:
  enabled: true
  status: in_progress      # pending | in_progress | paused | completed | error
  start_time: 2026-02-24T10:00:00Z
  last_update: 2026-02-24T10:30:00Z
  completed_phases: [P3, P4]
  current_phase: P5
  current_attempt: 1

  circuit_breaker:
    triggered: false
    reason: null
    retry_count: 0

  audit_logs:
    - phase: P3
      log_file: yolo-logs/phase-P3.log
      status: completed
```

#### M004 Ralph Loop 集成

**职责**：调用和监控 Ralph Loop 执行

**集成方式**：
1. 动态生成 `.claude/ralph/PROMPT.md`
2. 调用 `ralph-loop.sh` 启动执行
3. 监控执行状态，处理中断
4. 记录执行日志

**PROMPT 模板**：
```markdown
# YOLO 模式执行提示

## 当前需求
{requirement_name}

## 执行范围
P3-P14 自动执行

## 执行规则
1. 每个阶段完成后调用对应的 Skill
2. 自动评审，不通过则修复重试
3. 连续 3 次失败触发熔断
4. 记录完整审计日志

## 阶段清单
- [ ] P3: 技术方案
- [ ] P4: 自动评审
- [ ] P5: 计划生成
...
```

#### M005 自动评审

**职责**：对各阶段输出进行自动评审

**评审标准**：
| 阶段 | 评审项 | 通过标准 |
|------|--------|----------|
| P4 | 技术方案 | 架构合理、技术可行、风险已识别 |
| P6 | 计划 | 任务完整、依赖清晰、估算合理 |
| P8 | 测试用例 | 覆盖率 ≥ 80%、边界条件覆盖 |
| P10 | 代码 | 规范符合、安全检查通过、可维护 |
| P12 | 测试报告 | 通过率 ≥ 80%、缺陷已修复 |
| P14 | 维基文档 | 完整、准确、可读 |

**评审流程**：
```
1. 读取阶段输出文件
2. 应用评审标准检查清单
3. 生成评审意见
4. 判定通过/不通过
5. 不通过则生成修改建议
```

#### M006 审计日志

**职责**：记录完整的执行过程

**日志格式**：
```markdown
# YOLO 执行日志 - {阶段名称}

## 执行信息
- 开始时间: {start_time}
- 结束时间: {end_time}
- 执行耗时: {duration}
- Token 消耗: {token_count}

## 执行过程
### Step 1: {step_name}
{step_details}

## 输出
- 生成文件: {output_files}
- 更新状态: {state_changes}

## 自动评审结果
- 状态: {review_status}
- 评审意见: {review_comments}
```

#### M007 熔断机制

**职责**：检测异常并暂停执行

**熔断条件**：
| 异常类型 | 阈值 | 触发动作 |
|----------|------|----------|
| 评审失败 | 连续 3 次不通过 | 暂停，记录日志 |
| 测试失败 | 通过率 < 80% | 暂停，记录失败用例 |
| 重复错误 | 同一错误 5 次 | 暂停，记录错误详情 |
| 执行超时 | 单阶段 > 30 分钟 | 暂停，记录进度 |
| Token 超限 | 达到上限 | 暂停，等待重置 |

**熔断处理**：
```
1. 记录熔断原因和时间
2. 更新状态为 paused
3. 生成熔断报告
4. 等待用户恢复指令
```

#### M008 中断恢复

**职责**：支持断点续传和状态恢复

**恢复流程**：
```
1. 读取流程状态文件
2. 验证已完成的阶段
3. 检查输出文件完整性
4. 从中断阶段继续执行
5. 重置熔断计数器
6. 记录恢复事件
```

**恢复命令**：
```bash
# 通过 Claude Code 恢复
/ideal-yolo --resume

# 或通过状态文件
# 将 yolo_mode.status 改为 in_progress
```

---

## 四、数据模型

### 4.1 核心数据模型

#### YoloModeConfig

```yaml
yolo_mode:
  # 基本配置
  enabled: boolean           # 是否启用
  status: enum               # pending | in_progress | paused | completed | error
  start_time: datetime       # 开始时间
  last_update: datetime      # 最后更新时间

  # 进度追踪
  completed_phases: list     # 已完成阶段列表
  current_phase: string      # 当前阶段
  current_attempt: int       # 当前尝试次数

  # 熔断状态
  circuit_breaker:
    triggered: boolean       # 是否触发
    reason: string           # 触发原因
    retry_count: int         # 重试次数
    triggered_at: datetime   # 触发时间

  # 审计日志索引
  audit_logs:
    - phase: string          # 阶段编号
      log_file: string       # 日志文件路径
      status: string         # 日志状态
      created_at: datetime   # 创建时间
```

#### AuditLogEntry

```yaml
log_entry:
  # 基本信息
  phase: string              # 阶段编号
  phase_name: string         # 阶段名称
  log_type: enum             # phase | review | error

  # 时间信息
  start_time: datetime       # 开始时间
  end_time: datetime         # 结束时间
  duration: int              # 执行耗时（秒）

  # 执行信息
  skill_used: string         # 使用的 Skill
  agent_used: string         # 使用的 Agent

  # 资源消耗
  token_count: int           # Token 消耗

  # 执行结果
  status: enum               # success | failure | skipped
  output_files: list         # 输出文件列表

  # 评审信息（仅评审日志）
  review:
    passed: boolean          # 是否通过
    comments: list           # 评审意见
    suggestions: list        # 修改建议
```

### 4.2 数据流设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           YOLO 模式数据流                                    │
└─────────────────────────────────────────────────────────────────────────────┘

用户操作                    系统处理                      数据存储
   │                          │                            │
   │ P2 评审通过              │                            │
   ├─────────────────────────→│                            │
   │                          │ 读取 流程状态.md           │
   │                          ├───────────────────────────→│
   │                          │                            │
   │                          │ 更新 yolo_mode.enabled     │
   │                          ├───────────────────────────→│
   │                          │                            │
   │ 选择 YOLO 模式           │                            │
   ├─────────────────────────→│                            │
   │                          │ 生成 PROMPT.md             │
   │                          ├───────────────────────────→│ .claude/ralph/
   │                          │                            │
   │                          │ 启动 Ralph Loop            │
   │                          │                            │
   │                          │ 执行 P3                    │
   │                          ├───────────────────────────→│
   │                          │                            │
   │                          │ 写入 phase-P3.log          │
   │                          ├───────────────────────────→│ yolo-logs/
   │                          │                            │
   │                          │ 自动评审 P4                │
   │                          ├───────────────────────────→│
   │                          │                            │
   │                          │ 写入 review-P4.log         │
   │                          ├───────────────────────────→│ yolo-logs/
   │                          │                            │
   │                          │ 更新 completed_phases      │
   │                          ├───────────────────────────→│ 流程状态.md
   │                          │                            │
   │                          │ ... 重复 P5-P14 ...        │
   │                          │                            │
   │ P15 最终确认             │                            │
   ├─────────────────────────→│                            │
   │                          │ 更新 yolo_mode.status      │
   │                          ├───────────────────────────→│ completed
   │                          │                            │
   ▼                          ▼                            ▼
```

---

## 五、接口设计

### 5.1 内部接口

| 接口编号 | 接口名称 | 输入 | 输出 | 说明 |
|----------|----------|------|------|------|
| I001 | enable_yolo | requirement_dir | success | 启用 YOLO 模式 |
| I002 | disable_yolo | requirement_dir | success | 禁用 YOLO 模式 |
| I003 | execute_phase | phase, context | result | 执行单个阶段 |
| I004 | auto_review | phase, output | review_result | 自动评审 |
| I005 | check_circuit | yolo_status | should_break | 检查熔断条件 |
| I006 | save_state | yolo_config | success | 保存状态 |
| I007 | load_state | requirement_dir | yolo_config | 加载状态 |
| I008 | write_log | log_entry | success | 写入日志 |
| I009 | resume_execution | requirement_dir | success | 恢复执行 |

### 5.2 外部接口

| 接口编号 | 接口名称 | 说明 |
|----------|----------|------|
| E001 | Ralph Loop CLI | 调用 `ralph-loop.sh` 启动执行 |
| E002 | Claude Code Skills | 调用现有 Skills 执行各阶段 |

### 5.3 接口详细设计

#### I001 enable_yolo

```python
def enable_yolo(requirement_dir: str) -> bool:
    """
    启用 YOLO 模式

    Args:
        requirement_dir: 需求目录路径

    Returns:
        bool: 启用是否成功

    Side Effects:
        - 更新 流程状态.md 中的 yolo_mode.enabled
        - 创建 yolo-logs/ 目录
        - 生成 .claude/ralph/PROMPT.md
    """
```

#### I004 auto_review

```python
def auto_review(phase: str, output: dict) -> ReviewResult:
    """
    自动评审

    Args:
        phase: 阶段编号 (P4, P6, P8, P10, P12, P14)
        output: 阶段输出内容

    Returns:
        ReviewResult:
            - passed: bool
            - comments: list[str]
            - suggestions: list[str]
    """
```

#### I005 check_circuit

```python
def check_circuit(yolo_status: YoloStatus) -> CircuitResult:
    """
    检查熔断条件

    Args:
        yolo_status: 当前 YOLO 模式状态

    Returns:
        CircuitResult:
            - should_break: bool
            - reason: str | None
            - action: str (pause | error | continue)
    """
```

---

## 六、风险分析与应对

### 6.1 主要风险

| 风险项 | 影响程度 | 发生概率 | 应对措施 |
|--------|----------|----------|----------|
| Ralph Loop 稳定性问题 | 高 | 中 | 充分测试，准备降级方案（手动模式） |
| 状态持久化失败 | 高 | 低 | 多重备份，支持手动恢复 |
| 自动评审质量不足 | 高 | 中 | 完善评审标准，持续优化检查清单 |
| Token 消耗过大 | 中 | 高 | 设置消耗上限，超出时暂停通知 |
| 中断恢复失败 | 高 | 低 | 多重状态持久化，支持手动恢复 |
| 熔断机制误触发 | 中 | 中 | 调整阈值，增加二次确认 |

### 6.2 风险应对策略

#### 策略 1：降级方案

当 YOLO 模式出现严重问题时，支持降级到传统模式：
1. 保留当前已完成的阶段
2. 切换到人工评审流程
3. 从中断点继续

#### 策略 2：多重备份

状态文件采用多重备份机制：
1. 每次更新前创建备份
2. 保留最近 5 个版本
3. 支持手动回滚

#### 策略 3：评审标准优化

持续优化自动评审标准：
1. 收集评审失败案例
2. 分析误判原因
3. 更新评审检查清单
4. 定期评估评审准确率

---

## 七、实施计划

### 7.1 阶段划分

| 阶段 | 内容 | 说明 |
|------|------|------|
| 阶段 1 | 核心框架 | 创建 ideal-yolo Skill，实现基础编排逻辑 |
| 阶段 2 | 状态管理 | 扩展流程状态文件，实现状态持久化 |
| 阶段 3 | Ralph Loop 集成 | 嵌入执行引擎，实现自动执行 |
| 阶段 4 | 自动评审 | 实现各阶段自动评审逻辑 |
| 阶段 5 | 审计日志 | 实现日志记录和存储 |
| 阶段 6 | 熔断机制 | 实现异常检测和暂停处理 |
| 阶段 7 | 中断恢复 | 实现断点续传和状态恢复 |
| 阶段 8 | 集成测试 | 端到端测试和优化 |

### 7.2 依赖关系

```
阶段 1 (核心框架)
    │
    ├──→ 阶段 2 (状态管理)
    │        │
    │        └──→ 阶段 5 (审计日志)
    │
    ├──→ 阶段 3 (Ralph Loop)
    │        │
    │        └──→ 阶段 4 (自动评审)
    │                 │
    │                 └──→ 阶段 6 (熔断机制)
    │                          │
    │                          └──→ 阶段 7 (中断恢复)
    │
    └──→ 阶段 8 (集成测试)
```

---

## 八、参考资料

1. [Ralph Loop - GitHub](https://github.com/frankbria/ralph-claude-code) - 自动化执行引擎
2. [Claude Code Hooks 文档](https://docs.anthropic.com/claude-code/hooks) - Hook 机制参考
3. [LangGraph 持久化执行](https://langchain-ai.github.io/langgraph/how-tos/persistence/) - 状态持久化参考
4. 本项目 CLAUDE.md - 15 阶段流程定义
5. 本项目 P1-需求文档.md - YOLO 模式需求规格

---

*文档版本: v1.0*
*创建时间: 2026-02-24*
*作者: Claude Code*
