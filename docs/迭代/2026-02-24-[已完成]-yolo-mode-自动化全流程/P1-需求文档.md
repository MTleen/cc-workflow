---
需求名称: YOLO 模式 - 自动化全流程执行
需求类型: software-feature
创建时间: 2026-02-24
当前阶段: P1
风险等级: 中
---

# P1-需求文档：YOLO 模式 - 自动化全流程执行

## 一、需求背景

### 1.1 现状分析

当前 Claude Code 中心化团队工作流采用 15 阶段流程（P1-P15），其中包含 7 个人工评审节点（P2、P4、P6、P8、P10、P12、P14）。对于企业用户而言，频繁的人工评审导致以下问题：

1. **流程中断频繁**：每个评审节点都需要人工介入，导致开发节奏被打断
2. **等待时间长**：评审人可能因其他工作无法及时响应，造成流程停滞
3. **上下文切换成本**：评审人需要重新理解上下文才能进行有效评审
4. **人力投入大**：对于标准化需求，人工评审的边际价值递减

### 1.2 问题陈述

企业用户在完成 P2 需求评审后，通常对需求有明确的理解和认可。此时，后续的 6 次评审（P4、P6、P8、P10、P12、P14）主要起到质量把关作用，但对于成熟团队和标准化需求，这些评审可以由大模型自动完成。

当前工作流缺乏一种"自动化执行"模式，允许用户在 P2 评审通过后，将后续阶段交给大模型自主执行，仅在最终成果提交（P15）时进行人工确认。

### 1.3 目标概述

本需求旨在新增 **YOLO 模式**（You Only Look Once），实现以下目标：

1. 在 P2 需求评审通过后，用户可选择启用 YOLO 模式
2. YOLO 模式下，P3-P14 阶段由大模型自动执行，包含自动评审和质量检查
3. 中间阶段的评审结果以完整审计日志形式记录，供用户事后查阅
4. 支持中断自动恢复，确保长时间执行任务的可靠性
5. 在 P15 成果提交阶段，由用户进行最终确认

---

## 二、目标用户

| 用户角色 | 使用场景 | 核心需求 |
|----------|----------|----------|
| 企业产品经理 | 标准化功能开发 | 减少评审等待时间，加快交付速度 |
| 技术负责人 | 低风险需求开发 | 降低评审人力投入，提高团队效率 |
| 项目经理 | 紧急需求交付 | 缩短从需求到上线的周期 |

---

## 三、功能需求

### 3.1 功能清单

| 功能编号 | 功能名称 | 功能描述 | 优先级 |
|----------|----------|----------|--------|
| F001 | YOLO 模式触发 | P2 评审通过后询问用户是否启用 YOLO 模式 | P0 |
| F002 | 自动化执行引擎 | 集成 Ralph Loop 实现 P3-P14 自动执行 | P0 |
| F003 | 自动评审机制 | 大模型自动进行阶段评审并记录结果 | P0 |
| F004 | 中断恢复机制 | 检测执行中断并自动恢复 | P0 |
| F005 | 审计日志记录 | 记录完整的评审意见、修改建议和执行结果 | P0 |
| F006 | 异常熔断机制 | 检测异常情况并暂停执行 | P0 |
| F007 | 进度通知 | 通过日志文件记录执行进度 | P1 |
| F008 | 状态持久化 | 在流程状态文件中记录 YOLO 模式状态 | P1 |

### 3.2 功能详细说明

#### F001 YOLO 模式触发

**触发时机**：P2 需求评审通过后

**交互流程**：
1. P2 评审通过时，系统询问用户："是否启用 YOLO 模式自动执行后续阶段（P3-P14）？"
2. 用户选择"是"：进入 YOLO 模式，启动自动执行
3. 用户选择"否"：继续传统的人工评审流程

**配置方式**：每次 P2 评审后询问，不设默认值

#### F002 自动化执行引擎

**技术方案**：集成 Ralph Loop 作为自动化执行引擎

**执行范围**：
- 起始阶段：P3（技术方案）
- 结束阶段：P14（维基评审）
- 最终确认：P15 由用户手动确认

**执行流程**：
```
P2 评审通过 → 用户选择 YOLO → 生成 .ralph/PROMPT.md
    ↓
Ralph Loop 启动 → P3 技术方案 → P4 自动评审 → ... → P14 维基评审
    ↓
P15 成果提交 → 用户确认 → 完成
```

**项目集成**：Ralph Loop 集成到本项目的 `.claude/ralph/` 目录

#### F003 自动评审机制

**评审阶段**：P4、P6、P8、P10、P12、P14

**评审内容**：
| 阶段 | 评审内容 | 评审标准 |
|------|----------|----------|
| P4 | 技术方案评审 | 架构合理性、技术可行性、风险识别 |
| P6 | 计划评审 | 任务完整性、依赖关系、时间估算 |
| P8 | 用例评审 | 覆盖率、边界条件、异常场景 |
| P10 | 代码评审 | 代码规范、安全性、可维护性 |
| P12 | 测试评审 | 测试通过率、缺陷修复、回归验证 |
| P14 | 维基评审 | 文档完整性、准确性、可读性 |

**评审结果处理**：
- 评审通过：继续下一阶段
- 评审不通过：生成修改建议，自动修复后重新评审
- 连续 3 次不通过：触发熔断机制，暂停并通知用户

#### F004 中断恢复机制

**中断检测**：
- API 调用限制（5 小时限制）
- 网络连接中断
- 进程异常终止
- 系统资源不足

**恢复策略**：
1. 检测到中断后，记录当前状态到流程状态文件
2. 等待恢复条件满足（如 API 限制重置）
3. 自动重新启动 Ralph Loop，从上次中断点继续执行

**状态持久化**：所有状态保存在 `流程状态.md` 中

#### F005 审计日志记录

**日志存储位置**：`docs/迭代/{需求名}/yolo-logs/`

**日志文件结构**：
```
yolo-logs/
├── phase-P3.log          # 技术方案执行日志
├── review-P4.log         # P4 自动评审日志
├── phase-P5.log          # 计划生成执行日志
├── review-P6.log         # P6 自动评审日志
├── ...
└── summary.log           # YOLO 模式执行摘要
```

**日志内容**：
- 执行时间戳
- 阶段名称和编号
- 评审意见（包含通过/不通过判定）
- 修改建议（如有）
- 执行结果
- Token 消耗统计

#### F006 异常熔断机制

**熔断条件**：

| 异常类型 | 阈值 | 处理方式 |
|----------|------|----------|
| 评审失败 | 连续 3 次不通过 | 暂停执行，记录日志，等待用户介入 |
| 测试失败 | 通过率 < 80% | 暂停执行，记录失败用例，等待用户介入 |
| 重复错误 | 同一错误重复 5 次 | 暂停执行，记录错误详情，等待用户介入 |

**熔断后恢复**：
1. 用户查看日志，了解问题原因
2. 用户手动修复问题或调整配置
3. 用户执行恢复命令继续执行

#### F007 进度通知

**通知方式**：写入日志文件

**日志文件位置**：`docs/迭代/{需求名}/yolo-logs/summary.log`

**通知内容**：
- 当前执行阶段
- 已完成阶段列表
- 待执行阶段列表
- 异常事件（如有）
- 预计剩余时间

#### F008 状态持久化

**流程状态文件扩展**：

```yaml
---
current_phase: P5
mode: yolo                    # 新增：yolo | normal
yolo_status: in_progress      # 新增：pending | in_progress | paused | completed | error
yolo_start_time: 2026-02-24T10:00:00Z
yolo_last_update: 2026-02-24T10:30:00Z
yolo_completed_phases: [P3, P4]
yolo_current_attempt: 1
stories_dir: docs/迭代/{需求名}/stories/
---
```

---

## 四、非功能需求

| 维度 | 要求 |
|------|------|
| 性能 | 单个阶段执行时间不超过 30 分钟；完整 YOLO 流程（P3-P14）执行时间不超过 8 小时 |
| 可用性 | 中断恢复成功率 ≥ 95%；熔断机制误触发率 < 5% |
| 安全性 | 审计日志包含完整的操作记录，支持追溯；敏感操作需记录到日志 |
| 兼容性 | 兼容现有的 15 阶段流程；支持与传统模式混合使用（中途切换） |

---

## 五、约束条件

| 约束类型 | 说明 |
|----------|------|
| 技术约束 | 依赖 Ralph Loop 作为自动化执行引擎；依赖 Claude Code CLI 的 --resume 功能 |
| 时间约束 | 无明确的交付时间要求 |
| 资源约束 | Token 消耗可能达到传统模式的 2-3 倍；需要考虑 API 调用限制 |

---

## 六、验收标准

### 6.1 功能验收

- [ ] P2 评审通过后，系统能够询问用户是否启用 YOLO 模式
- [ ] 用户选择 YOLO 模式后，系统能够自动执行 P3-P14 阶段
- [ ] 每个阶段完成后，流程状态文件能够正确更新
- [ ] 自动评审能够生成完整的评审意见和修改建议
- [ ] 评审不通过时，系统能够自动修复并重新评审
- [ ] 连续 3 次评审失败时，系统能够暂停并记录日志
- [ ] 测试通过率 < 80% 时，系统能够暂停并记录失败用例
- [ ] 同一错误重复 5 次时，系统能够暂停并记录错误详情
- [ ] 中断后系统能够自动恢复并继续执行
- [ ] 审计日志能够记录完整的执行过程
- [ ] P15 阶段能够正确等待用户确认

### 6.2 非功能验收

- [ ] 单个阶段执行时间不超过 30 分钟
- [ ] 完整 YOLO 流程执行时间不超过 8 小时
- [ ] 中断恢复成功率 ≥ 95%
- [ ] 熔断机制误触发率 < 5%
- [ ] YOLO 模式与传统模式能够平滑切换

---

## 七、风险评估

| 风险项 | 影响程度 | 发生概率 | 应对措施 |
|--------|----------|----------|----------|
| Ralph Loop 稳定性问题 | 高 | 中 | 充分测试，准备降级方案（手动模式） |
| Token 消耗过大 | 中 | 高 | 设置消耗上限，超出时暂停并通知用户 |
| 自动评审质量不足 | 高 | 中 | 完善评审标准和检查清单，持续优化 |
| 中断恢复失败 | 高 | 低 | 多重状态持久化，支持手动恢复 |
| 熔断机制误触发 | 中 | 中 | 调整阈值，增加二次确认机制 |

---

## 八、参考资料

1. [Ralph Loop - GitHub](https://github.com/frankbria/ralph-claude-code) - 自动化执行引擎
2. [Claude Code Hooks 文档](https://docs.anthropic.com/claude-code/hooks) - Hook 机制参考
3. [LangGraph 持久化执行](https://langchain-ai.github.io/langgraph/how-tos/persistence/) - 状态持久化参考
4. 本项目 CLAUDE.md - 15 阶段流程定义
5. 本项目 README.md - 系统架构说明

---

*文档版本: v1.0*
*创建时间: 2026-02-24*
*作者: Claude Code*
