---
需求名称: 流程阶段精简——删除上线阶段并新增成果提交阶段
需求类型: refactoring
创建时间: 2026-02-23
当前阶段: P1
风险等级: 中
---

# P1-需求文档：流程阶段精简——删除上线阶段并新增成果提交阶段

## 一、重构背景

### 1.1 当前状态

CC-Workflow 项目当前定义了 16 个阶段流程（P1-P16），分为四个阶段组：

- **规划阶段**：P1 需求编写 → P2 需求评审 → P3 技术方案 → P4 方案评审
- **准备阶段**：P5 计划生成 → P6 计划评审 → P7 测试用例 → P8 用例评审
- **执行阶段**：P9 开发执行 → P10 代码评审 → P11 测试执行 → P12 测试评审
- **收尾阶段**：P13 上线评审 → P14 部署上线 → P15 维基更新 → P16 维基评审

当前阶段定义分布在以下文件中：
- `.claude/skills/ideal-flow-control/references/flow-state-spec.md`
- `CLAUDE.md`
- `README.md`
- 各 Skill 文档及 Wiki 文档

### 1.2 存在的问题

| 问题类型 | 具体描述 | 影响 |
|----------|----------|------|
| 流程冗余 | P13 上线评审、P14 部署上线在企业级项目中不合理 | 增加不必要的评审环节，延长交付周期 |
| 自动化冲突 | 上线应由 CI/CD 自动化完成，不应作为人工阶段 | 违背自动化原则，与 CI/CD 流程职责重叠 |
| 流程缺口 | 维基评审后缺少明确的成果提交环节 | 代码合并、worktree 清理、PR 提交等操作无明确归属 |

### 1.3 重构目标

1. **删除上线阶段**：移除 P13 上线评审、P14 部署上线，上线由 CI/CD 自动化完成
2. **重新编号**：原 P15 维基更新 → P13，原 P16 维基评审 → P14
3. **新增成果提交**：P15 成果提交阶段，由 Claude 自动执行合并代码、删除 worktree、提交 PR
4. **最终形成 15 阶段流程**

---

## 二、重构范围

### 2.1 涉及模块

| 模块名称 | 当前职责 | 重构后职责 |
|----------|----------|------------|
| `ideal-flow-control` | 控制 P1-P16 流程 | 控制 P1-P15 流程 |
| `ideal-wiki` | P15 维基更新 | P13 维基更新 |
| `ideal-requirement` | 需求收集（含阶段引用） | 更新阶段引用 |
| `ideal-init` | 初始化流程状态 | 更新流程状态模板 |
| `CLAUDE.md` | 描述 16 阶段 | 描述 15 阶段 |
| `README.md` | 三、阶段流程定义 P1-P16 | 更新为 P1-P15 |
| Wiki 文档 | 用户指南、开发指南 | 更新阶段引用 |
| 脚本文件 | flow-state.py, generate-flow-status.py | 更新阶段逻辑 |

### 2.2 不涉及的模块

- P1-P12 阶段的定义和逻辑保持不变
- 各 Skill 的核心功能逻辑不变
- CI/CD 配置文件

---

## 三、重构方案

### 3.1 方案概述

1. **删除阶段**：移除 P13 上线评审、P14 部署上线
2. **重新编号**：原 P15 维基更新 → P13，原 P16 维基评审 → P14
3. **新增阶段**：P15 成果提交（由 Claude 自动执行：合并代码、删除 worktree、提交 PR）
4. **文档更新**：同步更新所有涉及的模块和文档

**调整后的 15 阶段流程：**
- **规划阶段**：P1-P4（需求编写→需求评审→技术方案→方案评审）
- **准备阶段**：P5-P8（计划生成→计划评审→测试用例→用例评审）
- **执行阶段**：P9-P12（开发执行→代码评审→测试执行→测试评审）
- **收尾阶段**：P13-P15（维基更新→维基评审→成果提交）

### 3.2 架构变更

**重构前（16阶段）：**

```
P1→P2→P3→P4→P5→P6→P7→P8→P9→P10→P11→P12→P13(上线评审)→P14(部署上线)→P15(维基更新)→P16(维基评审)
```

**重构后（15阶段）：**

```
P1→P2→P3→P4→P5→P6→P7→P8→P9→P10→P11→P12→P13(维基更新)→P14(维基评审)→P15(成果提交)
```

### 3.3 详细设计

#### P15 成果提交阶段定义

| 属性 | 值 |
|------|------|
| 阶段编号 | P15 |
| 阶段名称 | 成果提交 |
| 执行者 | Claude（自动执行） |
| 触发条件 | P14 维基评审通过 |
| 输入 | 全部阶段通过状态 |

**执行内容：**
1. 合并代码到主分支
2. 删除 Git worktree
3. 提交 Pull Request
4. 触发 CI/CD 流水线（自动）

**输出：**
- 已合并的代码
- 已提交的 PR
- CI/CD 流水线触发状态

---

## 四、实施计划

### 4.1 实施步骤

| 步骤 | 内容 |
|------|------|
| 1 | 更新 `flow-state-spec.md` 流程状态规范 |
| 2 | 更新 `CLAUDE.md` 项目说明 |
| 3 | 更新 `README.md` 阶段流程定义 |
| 4 | 更新 `.claude/skills/ideal-wiki/SKILL.md` |
| 5 | 更新 `.claude/skills/ideal-requirement/SKILL.md` |
| 6 | 更新 `.claude/skills/ideal-init/SKILL.md` 及模板 |
| 7 | 更新 `ideal-best-practice` 包中的相关 Skills |
| 8 | 更新 Wiki 文档（用户指南、开发指南） |
| 9 | 更新脚本文件（flow-state.py, generate-flow-status.py） |

### 4.2 依赖关系

- 步骤 1 为核心规范更新，其他步骤依赖其完成
- 步骤 2-6 可并行执行
- 步骤 7-9 依赖步骤 1-6 完成

---

## 五、风险评估

### 5.1 技术风险

| 风险项 | 影响程度 | 发生概率 | 应对措施 |
|--------|----------|----------|----------|
| 文档遗漏 | 中 | 中 | 全面检索并建立检查清单 |
| 阶段编号不一致 | 高 | 中 | 使用全局搜索替换，逐个确认 |
| 脚本逻辑错误 | 中 | 低 | 修改后进行功能测试 |

### 5.2 业务风险

| 风险项 | 影响程度 | 发生概率 | 应对措施 |
|--------|----------|----------|----------|
| 团队成员不熟悉新流程 | 低 | 中 | 更新文档并通知团队 |
| 现有迭代状态文件不兼容 | 中 | 低 | 提供迁移指南或脚本 |

---

## 六、兼容性分析

### 6.1 接口变更

| 接口 | 变更类型 | 兼容性影响 |
|------|----------|------------|
| flow-state-spec.md | 阶段编号变更 | 现有流程状态文件需更新 |
| Skill 阶段引用 | 编号调整 | 无功能影响 |
| 脚本阶段判断 | 编号调整 | 需同步更新 |

### 6.2 数据迁移

现有迭代目录中的 `流程状态.md` 文件需要更新阶段编号引用。建议提供迁移脚本自动处理。

---

## 七、测试策略

### 7.1 测试范围

- [ ] 单元测试：脚本函数测试
- [ ] 集成测试：流程状态流转测试
- [x] 回归测试：全局搜索验证无遗漏
- [ ] 性能测试：不适用

### 7.2 测试用例

| 测试项 | 预期结果 |
|--------|----------|
| 全局搜索 "P13" | 无上线评审相关引用 |
| 全局搜索 "P14" | 无部署上线相关引用 |
| 全局搜索 "P15" | 仅成果提交阶段引用 |
| 全局搜索 "P16" | 无引用 |
| 流程状态模板生成 | 包含 P1-P15 |
| Wiki 更新触发 | 正确识别 P13 |

---

## 八、验收标准

### 8.1 功能验收

- [ ] 所有文件中 P13-P16 的引用已更新为 P13-P15
- [ ] flow-state-spec.md 中的阶段定义已更新
- [ ] CLAUDE.md 中的阶段描述已更新
- [ ] README.md 中的流程图和表格已更新
- [ ] ideal-wiki SKILL.md 中的阶段引用已更新
- [ ] 所有 Wiki 文档中的阶段引用已更新
- [ ] 脚本文件中的阶段逻辑已更新
- [ ] 新增 P15 成果提交阶段的定义已完整

### 8.2 质量验收

- [ ] 全局搜索无遗漏的旧阶段编号引用
- [ ] 流程状态模板可用
- [ ] 文档一致性检查通过

---

*文档版本: v1.0*
*创建时间: 2026-02-23*
*作者: Claude Code*
