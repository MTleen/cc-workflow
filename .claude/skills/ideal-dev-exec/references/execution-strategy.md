# TDD 执行策略

## 1. 配置读取

### 1.1 项目配置

启动时读取 `.claude/project-config.md`：

| 配置项 | 路径 | 默认值 |
|--------|------|--------|
| default_branch | Git 配置.分支策略.默认分支 | main |
| branch_prefix.feature | Git 配置.分支策略.功能分支前缀 | feature/ |
| branch_prefix.fix | Git 配置.分支策略.修复分支前缀 | fix/ |
| test_command | 执行配置.命令映射.测试 | npm test |
| build_command | 执行配置.命令映射.构建 | npm run build |

### 1.2 配置缺失处理

如果 `project-config.md` 不存在或配置项缺失，使用默认值。

## 2. 依赖图解析

### 2.1 Mermaid 解析

从 P5 的 Mermaid flowchart 中提取：

1. 节点列表（模块）
2. 边列表（依赖关系）
3. subgraph 分组（并行组）

### 2.2 拓扑排序

使用 Kahn 算法进行拓扑排序：

1. 计算每个节点的入度
2. 入度为 0 的节点加入当前层
3. 移除当前层节点的出边
4. 重复直到所有节点处理完毕

### 2.3 批次生成

按拓扑层级生成执行批次：
- Layer 0: 所有无依赖的模块
- Layer N: 所有依赖 Layer N-1 的模块

## 3. 并行执行

### 3.1 Task Tool 调用

**单批次多任务**:

在单个响应中发起多个 Task tool 调用，实现真正的并行执行。

### 3.2 结果收集

每个 Task 完成后：
1. 检查返回结果
2. 验证测试通过
3. 更新 TodoWrite
4. 如有失败，暂停并报告

### 3.3 错误处理

| 错误类型 | 处理方式 |
|----------|----------|
| 单任务失败 | 暂停批次，报告错误，等待介入 |
| 依赖失败 | 跳过依赖此任务的所有后续任务 |
| 超时 | 标记超时，报告进度，等待介入 |

## 4. 进度报告

### 4.1 批次报告

每个批次完成后输出执行状态和累计进度。

### 4.2 最终报告

所有任务完成后输出总结报告。

---

## RED-GREEN-REFACTOR 循环

### RED 阶段（写测试）

1. **理解需求**：明确要实现的功能
2. **编写测试**：编写一个会失败的测试
3. **运行测试**：确认测试失败
4. **确认失败原因**：确保失败是因为功能未实现，而非测试错误

### GREEN 阶段（写代码）

1. **编写最小代码**：只写足够让测试通过的代码
2. **运行测试**：确认测试通过
3. **不过度实现**：不要添加测试未覆盖的功能

### REFACTOR 阶段（优化）

1. **清理代码**：消除重复、改善命名
2. **保持测试通过**：每次小改动后运行测试
3. **提交代码**：重构完成后提交

## Git 分支策略

### 分支命名规范

| 类型 | 命名格式 | 示例 |
|------|----------|------|
| 功能开发 | `feature/{需求名称}` | `feature/user-login` |
| Bug 修复 | `fix/{bug名称}` | `fix/login-error` |
| 重构 | `refactor/{重构名称}` | `refactor/auth-module` |
| 热修复 | `hotfix/{修复名称}` | `hotfix/security-patch` |

### 分支操作

```bash
# 创建并切换分支
git checkout -b feature/{需求名称}

# 提交代码
git add .
git commit -m "feat(module): 实现某某功能"

# 推送分支
git push -u origin feature/{需求名称}
```

## 提交信息规范

### 格式

```
{type}({scope}): {subject}

{body}

{footer}
```

### 类型

| 类型 | 说明 |
|------|------|
| `feat` | 新功能 |
| `fix` | Bug 修复 |
| `refactor` | 重构 |
| `test` | 测试相关 |
| `docs` | 文档更新 |
| `style` | 代码格式（不影响功能） |
| `chore` | 构建/工具变动 |

### 示例

```
feat(auth): 实现用户登录功能

- 添加登录表单验证
- 实现 JWT 认证
- 添加登录状态管理

Closes #123
```

## MR 创建规范

### MR 标题

```
[需求名称] 功能描述
```

### MR 描述模板

```markdown
## 变更说明

简要描述本次变更的内容和目的。

## 变更类型

- [ ] 新功能
- [ ] Bug 修复
- [ ] 重构
- [ ] 文档更新

## 测试情况

- [ ] 单元测试已通过
- [ ] 集成测试已通过
- [ ] 手动测试已通过

## 相关链接

- 需求文档：{链接}
- 测试用例：{链接}
```

## 验证清单

每个任务完成后必须验证：

- [ ] 测试先写且先失败
- [ ] 最小代码使测试通过
- [ ] 所有测试通过
- [ ] 代码已提交
- [ ] 提交信息符合规范
