---
需求名称: CC-Workflow 自动化工作流平台
关联需求: P1-需求文档.md
创建时间: 2026-02-18
当前阶段: P3
---

# P3-技术方案：CC-Workflow 自动化工作流平台

## 一、方案概述

### 1.1 设计目标

基于 P1 需求文档，设计并实现一套以 Claude Code 为中心的团队工作流自动化平台。系统采用**文档驱动**的架构模式，通过 Obsidian vault 作为文档中心，结合 Claude Code skills 实现各阶段自动化。

### 1.2 核心设计原则

| 原则 | 说明 |
|------|------|
| **文档即状态** | 所有流程状态、决策记录、输出产物均以 Markdown 文档形式存储 |
| **Skills 即能力** | Claude Code 的能力通过 skills 定义，可扩展、可迭代 |
| **手动触发优先** | MVP 阶段采用手动触发机制，降低系统复杂度 |
| **渐进增强** | 基于现有 skills 补充完善，而非推倒重来 |

### 1.3 技术栈选型

| 层级 | 技术选型 | 选型理由 |
|------|----------|----------|
| 文档存储 | Markdown + Git | 版本控制、团队协作、工具兼容 |
| 文档编辑 | Obsidian | 双向链接、图谱视图、插件生态 |
| 代码托管 | Gitea（本地部署） | 内网隔离、自主可控 |
| AI 引擎 | Claude Code | 原生 skills 支持、命令行集成 |
| Skills 框架 | Superpowers 模式 | 成熟方法论、可复用性强 |

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           CC-Workflow 系统架构                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    文档层 (docs/ - Obsidian Vault)                │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │    │
│  │  │ 项目状态  │  │ 迭代文档  │  │ Wiki 文档 │  │ 流程状态  │         │    │
│  │  │.md      │  │ P1-P15   │  │ 用户/开发 │  │.md      │         │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                   │                                      │
│                                   │ 读写                                  │
│                                   ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Skills 层 (.claude/skills/)                    │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │    │
│  │  │ideal-        │  │ideal-dev-    │  │ideal-test-   │  ...      │    │
│  │  │requirement   │  │solution      │  │case          │           │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                   │                                      │
│                                   │ 调用                                  │
│                                   ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Claude Code 引擎                               │    │
│  │  ┌──────────────────────────────────────────────────────────┐   │    │
│  │  │  • 自然语言理解  • 代码生成  • 文档生成  • 测试执行       │   │    │
│  │  └──────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                   │                                      │
│                                   │ Git 操作                              │
│                                   ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    代码托管层 (Gitea)                             │    │
│  │  ┌──────────────────────────────────────────────────────────┐   │    │
│  │  │  • 仓库管理  • MR/PR  • Issue  • CI/CD (可选)            │   │    │
│  │  └──────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构设计

```
cc-workflow/                           # 项目根目录
│
├── .claude/                           # Claude Code 配置
│   ├── CLAUDE.md                      # 项目指令（全局上下文）
│   ├── skills/                        # 定制化 skills
│   │   ├── ideal-requirement/         # P1 需求编写
│   │   │   ├── SKILL.md
│   │   │   ├── references/
│   │   │   └── scripts/
│   │   ├── ideal-dev-solution/        # P3 技术方案（待开发）
│   │   ├── ideal-dev-plan/            # P5 计划生成（待开发）
│   │   ├── ideal-test-case/           # P7 测试用例（待开发）
│   │   ├── ideal-dev-exec/            # P9 开发执行（待开发）
│   │   ├── ideal-test-exec/           # P11 测试执行（待开发）
│   │   ├── ideal-wiki/                # P13 维基更新（待开发）
│   │   └── ideal-flow-control/        # 流程控制（待开发）
│   └── plans/                         # 编码计划（临时文件）
│
├── docs/                              # Obsidian vault
│   ├── .obsidian/                     # Obsidian 配置
│   ├── .automation/                   # 自动化配置（预留）
│   │   └── config.yaml
│   │
│   ├── CLAUDE.md                      # 项目说明（符号链接）
│   ├── 项目状态.md                     # 项目看板
│   ├── 产品愿景.md
│   ├── 产品路线图.md
│   │
│   ├── 迭代/                          # 需求迭代
│   │   └── {需求名称}/
│   │       ├── P1-需求文档.md
│   │       ├── P3-技术方案.md
│   │       ├── P5-编码计划.md
│   │       ├── P7-测试用例.md
│   │       ├── P11-测试报告.md
│   │       └── 流程状态.md
│   │
│   └── Wiki/                          # 维基文档
│       ├── 用户文档/
│       ├── 开发文档/
│       └── 接口文档/
│
├── templates/                         # 模板文件
│   └── docs/
│       ├── 需求文档-软件功能.md
│       ├── 需求文档-Bug修复.md
│       ├── 需求文档-重构优化.md
│       ├── 技术方案.md
│       ├── 编码计划.md
│       ├── 测试用例.md
│       └── 测试报告.md
│
└── README.md
```

---

## 三、15 阶段流程设计

### 3.1 阶段总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            15 阶段流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  【规划阶段】                                                             │
│   P1(需求编写) ──▶ P2(需求评审) ──▶ P3(技术方案) ──▶ P4(方案评审)        │
│       Claude            人工            Claude            人工          │
│                                                                          │
│  【准备阶段】                                                             │
│   P5(计划生成) ──▶ P6(计划评审) ──▶ P7(测试用例) ──▶ P8(用例评审)        │
│       Claude            人工            Claude            人工          │
│                                                                          │
│  【执行阶段】                                                             │
│   P9(开发执行) ──▶ P10(代码评审) ──▶ P11(测试执行) ──▶ P12(测试评审)     │
│       Claude            人工             Claude            人工         │
│                                                                          │
│  【收尾阶段】                                                             │
│   P13(维基更新) ──▶ P14(维基评审) ──▶ P15(成果提交)                      │
│        Claude            人工             自动                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 各阶段 Skill 映射

| 阶段 | Skill 名称 | 输入 | 输出 | 状态 |
|------|------------|------|------|------|
| P1 | `ideal-requirement` | 需求想法 | P1-需求文档.md | ✅ 已实现 |
| P2 | 人工评审 | P1 文档 | 评审意见 | - |
| P3 | `ideal-dev-solution` | P1 文档 | P3-技术方案.md | ⏳ 待开发 |
| P4 | 人工评审 | P3 文档 | 评审意见 | - |
| P5 | `ideal-dev-plan` | P3 文档 | P5-编码计划.md | ⏳ 待开发 |
| P6 | 人工评审 | P5 文档 | 评审意见 | - |
| P7 | `ideal-test-case` | P1 + P5 文档 | P7-测试用例.md | ⏳ 待开发 |
| P8 | 人工评审 | P7 文档 | 评审意见 | - |
| P9 | `ideal-dev-exec` | P5 文档 | 代码 + MR | ⏳ 待开发 |
| P10 | 人工评审 | MR | Approve/修改 | - |
| P11 | `ideal-test-exec` | P7 文档 | P11-测试报告.md | ⏳ 待开发 |
| P12 | 人工评审 | P11 文档 | 通过/修复 | - |
| P13 | `ideal-wiki` | 代码 + P1 文档 | Wiki 文档 | ⏳ 待开发 |
| P14 | 人工评审 | Wiki 文档 | 发布许可 | - |
| P15 | CI/CD | 代码 + 文档 | 生产环境 | - |

### 3.3 流程状态控制

通过 `流程状态.md` 文件控制阶段流转：

```yaml
---
requirement_name: {需求名称}
current_phase: P6
status: in_progress
created_at: 2026-02-18
updated_at: 2026-02-18
---

## 阶段状态

| 阶段 | 状态 | 更新时间 |
|------|------|----------|
| P1 需求编写 | ✅ completed | 2026-02-18 |
| P2 需求评审 | ✅ completed | 2026-02-18 |
| P3 技术方案 | ✅ completed | 2026-02-18 |
| P4 方案评审 | ✅ completed | 2026-02-18 |
| P5 计划生成 | ✅ completed | 2026-02-18 |
| P6 计划评审 | 🔄 in_progress | - |
| ... | ⏳ pending | - |
```

**触发机制**：
- MVP 阶段：人工修改状态字段，然后调用对应 skill
- 后续阶段：可通过文件监听自动触发

---

## 四、Skills 设计

### 4.1 Skill 架构

每个 Skill 遵循 Superpowers 模式：

```
ideal-{domain?}-{function}/
├── SKILL.md              # 核心指令文件
├── references/           # 参考文档
│   ├── templates/        # 输出模板
│   └── examples/         # 示例文档
└── scripts/              # 辅助脚本（可选）
```

### 4.2 Skill 详细设计

#### 4.2.1 ideal-requirement（P1）✅ 已实现

**功能**：通过苏格拉底式对话收集需求，生成标准化需求文档

**核心流程**：
1. 读取项目背景（CLAUDE.md / README.md）
2. 识别需求类型（软件功能/Bug修复/重构优化）
3. 加载对应模板
4. 苏格拉底式对话收集信息
5. 生成需求文档 + 流程状态文件

**已实现特性**：
- 项目背景自动加载
- 三种需求类型模板
- 正式学术风格指南
- 进度指示器

#### 4.2.2 ideal-dev-solution（P3）⏳ 待开发

**功能**：基于需求文档生成技术方案

**核心流程**：
1. 读取 P1-需求文档.md
2. 分析功能需求和非功能需求
3. 设计系统架构
4. 确定技术选型
5. 设计数据模型和接口
6. 生成 P3-技术方案.md

**输入**：
- P1-需求文档.md
- CLAUDE.md（项目上下文）

**输出**：
- P3-技术方案.md（包含：架构设计、技术选型、数据模型、接口设计、风险分析）

#### 4.2.3 ideal-dev-plan（P5）⏳ 待开发

**功能**：将技术方案分解为可执行的原子任务

**核心流程**：
1. 读取 P3-技术方案.md
2. 识别功能模块
3. 分解为 2-5 分钟的原子任务
4. 按 TDD 模式组织任务（测试先行）
5. 生成 P5-编码计划.md

**任务格式**：
```markdown
## 任务 {id}: {任务名称}

**目标**：{一句话描述}

**步骤**：
1. [ ] 编写失败测试
2. [ ] 运行确认失败
3. [ ] 实现最小代码
4. [ ] 运行确认通过
5. [ ] 提交代码

**验证标准**：{如何验证完成}
```

#### 4.2.4 ideal-test-case（P7）⏳ 待开发

**功能**：基于需求和编码计划生成测试用例

**核心流程**：
1. 读取 P1-需求文档.md + P5-编码计划.md
2. 提取功能点和验收标准
3. 生成功能测试用例
4. 生成边界条件测试用例
5. 生成异常场景测试用例
6. 输出 P7-测试用例.md

**测试用例格式**：
```markdown
## TC-{id}: {测试用例名称}

**前置条件**：{测试前需满足的条件}

**测试步骤**：
1. {步骤1}
2. {步骤2}

**预期结果**：{期望的输出或状态}

**优先级**：P0/P1/P2
```

#### 4.2.5 ideal-dev-exec（P9）⏳ 待开发

**功能**：按编码计划执行开发任务

**核心流程**：
1. 读取 P5-编码计划.md
2. 按 TDD 模式逐任务执行
3. 每任务完成后运行测试验证
4. 创建 Git 分支和 MR
5. 输出执行报告

**TDD 循环**：
```
RED（写测试）→ GREEN（写代码）→ REFACTOR（重构）→ 重复
```

#### 4.2.6 ideal-test-exec（P11）⏳ 待开发

**功能**：执行测试用例并生成报告

**核心流程**：
1. 读取 P7-测试用例.md
2. 执行自动化测试（如适用）
3. 手动测试用例执行指导
4. 收集测试结果
5. 生成 P11-测试报告.md

#### 4.2.7 ideal-wiki（P13）⏳ 待开发

**功能**：基于代码和需求文档生成维基文档

**核心流程**：
1. 读取代码和 P1-需求文档.md
2. 分析代码结构和功能
3. 生成用户文档
4. 生成开发文档
5. 生成接口文档
6. 输出到 docs/Wiki/

#### 4.2.8 ideal-flow-control（流程控制）⏳ 待开发

**功能**：统一管理流程状态和阶段触发

**核心流程**：
1. 读取当前流程状态
2. 验证前置条件
3. 调用对应阶段 skill
4. 更新流程状态

---

## 五、数据模型

### 5.1 流程状态模型

```yaml
# 流程状态.md
requirement_name: string      # 需求名称
current_phase: P1-P15        # 当前阶段
status: pending|in_progress|completed|blocked|revision
created_at: datetime         # 创建时间
updated_at: datetime         # 更新时间

# 各阶段状态
phases:
  P1: { status, updated_at, reviewer }
  P2: { status, updated_at, reviewer }
  ...
  P15: { status, updated_at, reviewer }
```

### 5.2 需求文档模型

```yaml
# P1-需求文档.md
---
需求名称: string
需求类型: software-feature|bug-fix|refactoring
创建时间: datetime
当前阶段: P1
风险等级: low|medium|high
---

## 一、需求背景
  - 现状分析
  - 问题陈述
  - 目标概述

## 二、目标用户
  - 用户角色表

## 三、功能需求
  - 功能清单
  - 功能详细说明

## 四、非功能需求
  - 性能、可用性、安全性、兼容性

## 五、约束条件
  - 技术约束、时间约束、资源约束

## 六、验收标准
  - 功能验收
  - 非功能验收

## 七、风险评估
  - 风险项、影响程度、发生概率、应对措施
```

---

## 六、接口设计

### 6.1 Skill 调用接口

MVP 阶段通过 Claude Code 命令行手动调用：

```bash
# P1 需求编写
/ideal-requirement [需求描述]

# P3 技术方案
/ideal-dev-solution

# P5 计划生成
/ideal-dev-plan

# P7 测试用例
/ideal-test-case

# P9 开发执行
/ideal-dev-exec

# P11 测试执行
/ideal-test-exec

# P13 维基更新
/ideal-wiki
```

### 6.2 文档路径约定

| 文档类型 | 路径模板 |
|----------|----------|
| 需求文档 | `docs/迭代/{需求名称}/P1-需求文档.md` |
| 技术方案 | `docs/迭代/{需求名称}/P3-技术方案.md` |
| 编码计划 | `docs/迭代/{需求名称}/P5-编码计划.md` |
| 测试用例 | `docs/迭代/{需求名称}/P7-测试用例.md` |
| 测试报告 | `docs/迭代/{需求名称}/P11-测试报告.md` |
| 流程状态 | `docs/迭代/{需求名称}/流程状态.md` |
| 维基文档 | `docs/Wiki/{类型}/{文档名}.md` |

---

## 七、风险分析与应对

### 7.1 主要风险

| 风险项 | 影响程度 | 发生概率 | 应对措施 |
|--------|----------|----------|----------|
| **Skills 质量不足** | 高 | 中 | 1. 建立技能测试机制 2. 逐步迭代优化 3. 建立 skills 评审流程 |
| Claude API 不可用 | 高 | 低 | 1. 流程可暂停等待 2. 记录当前状态 3. 人工介入处理 |
| 团队学习成本 | 中 | 中 | 1. 提供培训文档 2. 选择试点项目验证 3. 渐进式推广 |
| 文档格式不统一 | 中 | 低 | 1. 统一模板 2. 自动格式校验 3. Skill 内置风格指南 |

### 7.2 Skills 质量保障策略

**核心风险：Skills 质量是最大风险**

应对策略：

1. **TDD 方法论**
   - 每个 skill 开发前先定义测试场景
   - 使用 `writing-skills` 模式
   - 验证 skill 能正确处理边界情况

2. **渐进式开发**
   - 从单个 skill 开始验证
   - 先跑通完整流程再优化
   - 每个阶段独立可测试

3. **评审机制**
   - Skill 输出需人工评审确认
   - 建立输出质量检查清单
   - 收集反馈持续迭代

4. **文档化**
   - 每个 skill 包含示例和最佳实践
   - 记录已知限制和边界情况
   - 建立 troubleshooting 指南

---

## 八、实施计划

### 8.1 MVP 范围

| 优先级 | 内容 | 说明 |
|--------|------|------|
| P0 | ideal-requirement | ✅ 已实现 |
| P0 | ideal-dev-solution | P3 技术方案 |
| P0 | ideal-dev-plan | P5 计划生成 |
| P0 | ideal-test-case | P7 测试用例 |
| P0 | ideal-dev-exec | P9 开发执行 |
| P0 | ideal-test-exec | P11 测试执行 |
| P0 | ideal-wiki | P13 维基更新 |
| P1 | ideal-flow-control | 流程状态管理 |

### 8.2 验证场景

选择一个简单功能（如"用户登录"），完整跑通 P1-P15 流程：

1. P1: 生成登录功能需求文档
2. P2: 人工评审通过
3. P3: 生成技术方案
4. P4: 人工评审通过
5. P5: 生成编码计划
6. P6: 人工评审通过
7. P7: 生成测试用例
8. P8: 人工评审通过
9. P9: 执行开发，创建 MR
10. P10: 人工代码评审
11. P11: 执行测试，生成报告
12. P12: 人工评审通过
13. P13: 生成维基文档
14. P14: 人工评审通过
15. P15: 成果提交（自动触发 CI/CD）

---

## 九、参考资料

1. [Superpowers GitHub](https://github.com/obra/Superpowers) - Skills 框架参考
2. [Superpowers writing-plans skill](https://github.com/obra/Superpowers/blob/master/skills/writing-plans/SKILL.md) - 编码计划模板
3. [Jesse Vincent's Blog - How I'm using coding agents](https://blog.fsck.com/2025/10/09/superpowers/) - AI 编程代理实践
4. `docs/spec-coding-superpowers-best-practices.md` - 本项目调研报告

---

*文档版本: v1.0*
*创建时间: 2026-02-18*
*作者: Claude Code*
